(function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};"undefined"!=typeof Backbone&&null!==Backbone&&(this.Content=function(_super){function Content(){return Content.__super__.constructor.apply(this,arguments)}return __extends(Content,_super),Content.contents={},Content.contentInfos={},Content.prototype.template=function(){return DiscussionUtil.getTemplate("_content")},Content.prototype.actions={editable:".admin-edit",can_reply:".discussion-reply",can_delete:".admin-delete",can_openclose:".admin-openclose"},Content.prototype.urlMappers={},Content.prototype.urlFor=function(name){return this.urlMappers[name].apply(this)},Content.prototype.can=function(action){return(this.get("ability")||{})[action]},Content.prototype.canBeEndorsed=function(){return!1},Content.prototype.updateInfo=function(info){return info?(this.set("ability",info.ability),this.set("voted",info.voted),this.set("subscribed",info.subscribed)):void 0},Content.prototype.addComment=function(comment,options){var comments_count,model,thread;return options||(options={}),options.silent||(thread=this.get("thread"),comments_count=parseInt(thread.get("comments_count")),thread.set("comments_count",comments_count+1)),this.get("children").push(comment),model=new Comment($.extend({},comment,{thread:this.get("thread")})),this.get("comments").add(model),this.trigger("comment:add"),model},Content.prototype.removeComment=function(comment){var comments_count,thread;return thread=this.get("thread"),comments_count=parseInt(thread.get("comments_count")),thread.set("comments_count",comments_count-1-comment.getCommentsCount()),this.trigger("comment:remove")},Content.prototype.resetComments=function(children){var comment,_i,_len,_ref,_results;for(this.set("children",[]),this.set("comments",new Comments),_ref=children||[],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)comment=_ref[_i],_results.push(this.addComment(comment,{silent:!0}));return _results},Content.prototype.initialize=function(){var userId;return Content.addContent(this.id,this),userId=this.get("user_id"),null!=userId?(this.set("staff_authored",DiscussionUtil.isStaff(userId)),this.set("community_ta_authored",DiscussionUtil.isTA(userId))):(this.set("staff_authored",!1),this.set("community_ta_authored",!1)),Content.getInfo(this.id)&&this.updateInfo(Content.getInfo(this.id)),this.set("user_url",DiscussionUtil.urlFor("user_profile",userId)),this.resetComments(this.get("children"))},Content.prototype.remove=function(){return"comment"===this.get("type")?(this.get("thread").removeComment(this),this.get("thread").trigger("comment:remove",this)):this.trigger("thread:remove",this)},Content.addContent=function(id,content){return this.contents[id]=content},Content.getContent=function(id){return this.contents[id]},Content.getInfo=function(id){return this.contentInfos[id]},Content.loadContentInfos=function(infos){var id,info;for(id in infos)info=infos[id],this.getContent(id)&&this.getContent(id).updateInfo(info);return $.extend(this.contentInfos,infos)},Content.prototype.pinThread=function(){var pinned;return pinned=this.get("pinned"),this.set("pinned",pinned),this.trigger("change",this)},Content.prototype.unPinThread=function(){var pinned;return pinned=this.get("pinned"),this.set("pinned",pinned),this.trigger("change",this)},Content.prototype.flagAbuse=function(){var temp_array;return temp_array=this.get("abuse_flaggers"),temp_array.push(window.user.get("id")),this.set("abuse_flaggers",temp_array),this.trigger("change",this)},Content.prototype.unflagAbuse=function(){return this.get("abuse_flaggers").pop(window.user.get("id")),this.trigger("change",this)},Content.prototype.isFlagged=function(){var flaggers,user,_ref;return user=DiscussionUtil.getUser(),flaggers=this.get("abuse_flaggers"),user&&(_ref=user.id,__indexOf.call(flaggers,_ref)>=0||DiscussionUtil.isPrivilegedUser(user.id)&&flaggers.length>0)},Content.prototype.incrementVote=function(increment){var newVotes;return newVotes=_.clone(this.get("votes")),newVotes.up_count=newVotes.up_count+increment,this.set("votes",newVotes)},Content.prototype.vote=function(){return this.incrementVote(1)},Content.prototype.unvote=function(){return this.incrementVote(-1)},Content}(Backbone.Model),this.Thread=function(_super){function Thread(){return Thread.__super__.constructor.apply(this,arguments)}return __extends(Thread,_super),Thread.prototype.urlMappers={retrieve:function(){return DiscussionUtil.urlFor("retrieve_single_thread",this.discussion.id,this.id)},reply:function(){return DiscussionUtil.urlFor("create_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},close:function(){return DiscussionUtil.urlFor("openclose_thread",this.id)},update:function(){return DiscussionUtil.urlFor("update_thread",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_thread",this.id)},follow:function(){return DiscussionUtil.urlFor("follow_thread",this.id)},unfollow:function(){return DiscussionUtil.urlFor("unfollow_thread",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)},pinThread:function(){return DiscussionUtil.urlFor("pin_thread",this.id)},unPinThread:function(){return DiscussionUtil.urlFor("un_pin_thread",this.id)}},Thread.prototype.initialize=function(){return this.set("thread",this),Thread.__super__.initialize.call(this)},Thread.prototype.comment=function(){return this.set("comments_count",parseInt(this.get("comments_count"))+1)},Thread.prototype.follow=function(){return this.set("subscribed",!0)},Thread.prototype.unfollow=function(){return this.set("subscribed",!1)},Thread.prototype.display_body=function(){return this.has("highlighted_body")?String(this.get("highlighted_body")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>"):this.get("body")},Thread.prototype.display_title=function(){return this.has("highlighted_title")?String(this.get("highlighted_title")).replace(/<highlight>/g,"<mark>").replace(/<\/highlight>/g,"</mark>"):this.get("title")},Thread.prototype.toJSON=function(){var json_attributes;return json_attributes=_.clone(this.attributes),_.extend(json_attributes,{title:this.display_title(),body:this.display_body()})},Thread.prototype.created_at_date=function(){return new Date(this.get("created_at"))},Thread.prototype.created_at_time=function(){return new Date(this.get("created_at")).getTime()},Thread.prototype.hasResponses=function(){return this.get("comments_count")>0},Thread}(this.Content),this.Comment=function(_super){function Comment(){var _this=this;return this.canBeEndorsed=function(){return Comment.prototype.canBeEndorsed.apply(_this,arguments)},Comment.__super__.constructor.apply(this,arguments)}return __extends(Comment,_super),Comment.prototype.urlMappers={reply:function(){return DiscussionUtil.urlFor("create_sub_comment",this.id)},unvote:function(){return DiscussionUtil.urlFor("undo_vote_for_"+this.get("type"),this.id)},upvote:function(){return DiscussionUtil.urlFor("upvote_"+this.get("type"),this.id)},downvote:function(){return DiscussionUtil.urlFor("downvote_"+this.get("type"),this.id)},endorse:function(){return DiscussionUtil.urlFor("endorse_comment",this.id)},update:function(){return DiscussionUtil.urlFor("update_comment",this.id)},_delete:function(){return DiscussionUtil.urlFor("delete_comment",this.id)},flagAbuse:function(){return DiscussionUtil.urlFor("flagAbuse_"+this.get("type"),this.id)},unFlagAbuse:function(){return DiscussionUtil.urlFor("unFlagAbuse_"+this.get("type"),this.id)}},Comment.prototype.getCommentsCount=function(){var count;return count=0,this.get("comments").each(function(comment){return count+=comment.getCommentsCount()+1}),count},Comment.prototype.canBeEndorsed=function(){var user_id;return user_id=window.user.get("id"),user_id&&(DiscussionUtil.isPrivilegedUser(user_id)||"question"===this.get("thread").get("thread_type")&&this.get("thread").get("user_id")===user_id)},Comment}(this.Content),this.Comments=function(_super){function Comments(){return Comments.__super__.constructor.apply(this,arguments)}return __extends(Comments,_super),Comments.prototype.model=Comment,Comments.prototype.initialize=function(){var _this=this;return this.bind("add",function(item){return item.collection=_this})},Comments.prototype.find=function(id){return _.first(this.where({id:id}))},Comments}(Backbone.Collection))}).call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.Discussion=function(_super){function Discussion(){return Discussion.__super__.constructor.apply(this,arguments)}return __extends(Discussion,_super),Discussion.prototype.model=Thread,Discussion.prototype.initialize=function(models,options){var _this=this;return null==options&&(options={}),this.pages=options.pages||1,this.current_page=1,this.sort_preference=options.sort,this.bind("add",function(item){return item.discussion=_this}),this.setSortComparator(this.sort_preference),this.on("thread:remove",function(thread){return _this.remove(thread)})},Discussion.prototype.find=function(id){return _.first(this.where({id:id}))},Discussion.prototype.hasMorePages=function(){return this.current_page<this.pages},Discussion.prototype.setSortComparator=function(sortBy){switch(sortBy){case"date":return this.comparator=this.sortByDateRecentFirst;case"votes":return this.comparator=this.sortByVotes;case"comments":return this.comparator=this.sortByComments}},Discussion.prototype.addThread=function(thread,options){var model;return this.find(thread.id)?void 0:(options||(options={}),model=new Thread(thread),this.add(model),model)},Discussion.prototype.retrieveAnotherPage=function(mode,options,sort_options,error){var data,url,_this=this;switch(null==options&&(options={}),null==sort_options&&(sort_options={}),null==error&&(error=null),data={page:this.current_page+1},_.contains(["unread","unanswered","flagged"],options.filter)&&(data[options.filter]=!0),mode){case"search":url=DiscussionUtil.urlFor("search"),data.text=options.search_text;break;case"commentables":url=DiscussionUtil.urlFor("search"),data.commentable_ids=options.commentable_ids;break;case"all":url=DiscussionUtil.urlFor("threads");break;case"followed":url=DiscussionUtil.urlFor("followed_threads",options.user_id)}return options.group_id&&(data.group_id=options.group_id),data.sort_key=sort_options.sort_key||"date",data.sort_order=sort_options.sort_order||"desc",DiscussionUtil.safeAjax({$elem:this.$el,url:url,data:data,dataType:"json",success:function(response){var models,new_collection,new_threads;return models=_this.models,new_threads=[function(){var _i,_len,_ref,_results;for(_ref=response.discussion_data,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)data=_ref[_i],_results.push(new Thread(data));return _results}()][0],new_collection=_.union(models,new_threads),Content.loadContentInfos(response.annotated_content_info),_this.pages=response.num_pages,_this.current_page=response.page,_this.reset(new_collection)},error:error})},Discussion.prototype.sortByDate=function(thread){return this.pinnedThreadsSortComparatorWithDate(thread,!0)},Discussion.prototype.sortByDateRecentFirst=function(thread){return this.pinnedThreadsSortComparatorWithDate(thread,!1)},Discussion.prototype.sortByVotes=function(thread1,thread2){var thread1_count,thread2_count;return thread1_count=parseInt(thread1.get("votes").up_count),thread2_count=parseInt(thread2.get("votes").up_count),this.pinnedThreadsSortComparatorWithCount(thread1,thread2,thread1_count,thread2_count)},Discussion.prototype.sortByComments=function(thread1,thread2){var thread1_count,thread2_count;return thread1_count=parseInt(thread1.get("comments_count")),thread2_count=parseInt(thread2.get("comments_count")),this.pinnedThreadsSortComparatorWithCount(thread1,thread2,thread1_count,thread2_count)},Discussion.prototype.pinnedThreadsSortComparatorWithCount=function(thread1,thread2,thread1_count,thread2_count){return thread1.get("pinned")&&!thread2.get("pinned")?-1:thread2.get("pinned")&&!thread1.get("pinned")?1:thread1_count>thread2_count?-1:thread2_count>thread1_count?1:thread1.created_at_time()>thread2.created_at_time()?-1:1},Discussion.prototype.pinnedThreadsSortComparatorWithDate=function(thread,ascending){var preferredDate,threadCreatedTime,today;return threadCreatedTime=new Date(thread.get("created_at")).getTime(),thread.get("pinned")?(today=new Date,preferredDate=new Date(today.getTime()+864e5+threadCreatedTime)):preferredDate=threadCreatedTime,ascending?preferredDate:-preferredDate},Discussion}(Backbone.Collection))}.call(this),function(){this.DiscussionFilter=function(){function DiscussionFilter(){}return DiscussionFilter.filterDrop=function(e){var $drop,$items,query;return $drop=$(e.target).parents(".topic-menu-wrapper"),query=$(e.target).val(),$items=$drop.find(".topic-menu-item"),0===query.length?void $items.removeClass("hidden"):($items.addClass("hidden"),$items.each(function(){var path,pathText,pathTitles;return path=$(this).parents(".topic-menu-item").andSelf(),pathTitles=path.children(".topic-title").map(function(i,elem){return $(elem).text()}).get(),pathText=pathTitles.join(" / ").toLowerCase(),query.split(" ").every(function(term){return-1!==pathText.search(term.toLowerCase())})?($(this).removeClass("hidden"),$(this).find(".topic-menu-item").removeClass("hidden"),$(this).parents(".topic-menu-item").removeClass("hidden")):void 0}))},DiscussionFilter}()}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionModuleView=function(_super){function DiscussionModuleView(){var _this=this;return this.navigateToPage=function(){return DiscussionModuleView.prototype.navigateToPage.apply(_this,arguments)},this.renderPagination=function(){return DiscussionModuleView.prototype.renderPagination.apply(_this,arguments)},this.addThread=function(){return DiscussionModuleView.prototype.addThread.apply(_this,arguments)},this.renderDiscussion=function(){return DiscussionModuleView.prototype.renderDiscussion.apply(_this,arguments)},this.loadPage=function(){return DiscussionModuleView.prototype.loadPage.apply(_this,arguments)},this.toggleDiscussion=function(){return DiscussionModuleView.prototype.toggleDiscussion.apply(_this,arguments)},this.hideDiscussion=function(){return DiscussionModuleView.prototype.hideDiscussion.apply(_this,arguments)},this.hideNewPost=function(){return DiscussionModuleView.prototype.hideNewPost.apply(_this,arguments)},this.toggleNewPost=function(){return DiscussionModuleView.prototype.toggleNewPost.apply(_this,arguments)},DiscussionModuleView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionModuleView,_super),DiscussionModuleView.prototype.events={"click .discussion-show":"toggleDiscussion","keydown .discussion-show":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleDiscussion)},"click .new-post-btn":"toggleNewPost","keydown .new-post-btn":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleNewPost)},"click .discussion-paginator a":"navigateToPage"},DiscussionModuleView.prototype.paginationTemplate=function(){return DiscussionUtil.getTemplate("_pagination")},DiscussionModuleView.prototype.page_re=/\?discussion_page=(\d+)/,DiscussionModuleView.prototype.initialize=function(){var match;return this.toggleDiscussionBtn=this.$(".discussion-show"),match=this.page_re.exec(window.location.href),this.page=match?parseInt(match[1]):1},DiscussionModuleView.prototype.toggleNewPost=function(event){return event.preventDefault(),this.newPostForm?(this.showed?this.newPostForm.slideDown(300):this.newPostForm.show(),this.toggleDiscussionBtn.addClass("shown"),this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion")),this.$("section.discussion").slideDown(),this.showed=!0):(this.toggleDiscussion(),void(this.isWaitingOnNewPost=!0))},DiscussionModuleView.prototype.hideNewPost=function(){return this.newPostForm.slideUp(300)},DiscussionModuleView.prototype.hideDiscussion=function(){return this.$("section.discussion").slideUp(),this.toggleDiscussionBtn.removeClass("shown"),this.toggleDiscussionBtn.find(".button-text").html(gettext("Show Discussion")),this.showed=!1},DiscussionModuleView.prototype.toggleDiscussion=function(){var $elem,_this=this;return this.showed?this.hideDiscussion():(this.toggleDiscussionBtn.addClass("shown"),this.toggleDiscussionBtn.find(".button-text").html(gettext("Hide Discussion")),this.retrieved?(this.$("section.discussion").slideDown(),this.showed=!0):($elem=this.toggleDiscussionBtn,this.loadPage($elem,function(){return _this.hideDiscussion(),DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the discussion. Please try again."))})))},DiscussionModuleView.prototype.loadPage=function($elem,error){var discussionId,url,_this=this;return discussionId=this.$el.data("discussion-id"),url=DiscussionUtil.urlFor("retrieve_discussion",discussionId)+("?page="+this.page),DiscussionUtil.safeAjax({$elem:$elem,$loading:$elem,takeFocus:!0,url:url,type:"GET",dataType:"json",success:function(response,textStatus){return _this.renderDiscussion($elem,response,textStatus,discussionId)},error:error})},DiscussionModuleView.prototype.renderDiscussion=function($elem,response,textStatus,discussionId){var $discussion,user,_this=this;return $elem.focus(),user=new DiscussionUser(response.user_info),window.user=user,DiscussionUtil.setUser(user),Content.loadContentInfos(response.annotated_content_info),DiscussionUtil.loadRoles(response.roles),this.course_settings=new DiscussionCourseSettings(response.course_settings),this.discussion=new Discussion,this.discussion.reset(response.discussion_data,{silent:!1}),$discussion=$(Mustache.render($("script#_inline_discussion").html(),{threads:response.discussion_data,discussionId:discussionId})),this.$("section.discussion").length?this.$("section.discussion").replaceWith($discussion):this.$el.append($discussion),this.newPostForm=$(".new-post-article"),this.threadviews=this.discussion.map(function(thread){var view;return view=new DiscussionThreadView({el:_this.$("article#thread_"+thread.id),model:thread,mode:"inline",course_settings:_this.course_settings,topicId:discussionId}),thread.on("thread:thread_type_updated",function(){return view.rerender(),view.expand()}),view}),_.each(this.threadviews,function(dtv){return dtv.render()}),DiscussionUtil.bulkUpdateContentInfo(window.$$annotated_content_info),this.newPostView=new NewPostView({el:this.newPostForm,collection:this.discussion,course_settings:this.course_settings,topicId:discussionId}),this.newPostView.render(),this.listenTo(this.newPostView,"newPost:cancel",this.hideNewPost),this.discussion.on("add",this.addThread),this.retrieved=!0,this.showed=!0,this.renderPagination(response.num_pages),this.isWaitingOnNewPost?this.newPostForm.show():void 0},DiscussionModuleView.prototype.addThread=function(thread){var article,threadView;return article=$("<article class='discussion-thread' id='thread_"+thread.id+"'></article>"),this.$("section.discussion > .threads").prepend(article),threadView=new DiscussionThreadView({el:article,model:thread,mode:"inline",course_settings:this.course_settings,topicId:this.$el.data("discussion-id")}),threadView.render(),this.threadviews.unshift(threadView)},DiscussionModuleView.prototype.renderPagination=function(numPages){var pageUrl,params,thing;return pageUrl=function(number){return"?discussion_page="+number},params=DiscussionUtil.getPaginationParams(this.page,numPages,pageUrl),thing=Mustache.render(this.paginationTemplate(),params),this.$("section.pagination").html(thing)},DiscussionModuleView.prototype.navigateToPage=function(event){var currPage,_this=this;return event.preventDefault(),window.history.pushState({},window.document.title,event.target.href),currPage=this.page,this.page=$(event.target).data("page-number"),this.loadPage($(event.target),function(){return _this.page=currPage,DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the threads you requested. Please try again."))})},DiscussionModuleView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionRouter=function(_super){function DiscussionRouter(){var _this=this;return this.hideNewPost=function(){return DiscussionRouter.prototype.hideNewPost.apply(_this,arguments)},this.showNewPost=function(){return DiscussionRouter.prototype.showNewPost.apply(_this,arguments)},this.navigateToAllThreads=function(){return DiscussionRouter.prototype.navigateToAllThreads.apply(_this,arguments)},this.navigateToThread=function(){return DiscussionRouter.prototype.navigateToThread.apply(_this,arguments)},this.showMain=function(){return DiscussionRouter.prototype.showMain.apply(_this,arguments)},this.setActiveThread=function(){return DiscussionRouter.prototype.setActiveThread.apply(_this,arguments)},DiscussionRouter.__super__.constructor.apply(this,arguments)}return __extends(DiscussionRouter,_super),DiscussionRouter.prototype.routes={"":"allThreads",":forum_name/threads/:thread_id":"showThread"},DiscussionRouter.prototype.initialize=function(options){var _this=this;return this.discussion=options.discussion,this.course_settings=options.course_settings,this.nav=new DiscussionThreadListView({collection:this.discussion,el:$(".forum-nav"),courseSettings:this.course_settings}),this.nav.on("thread:selected",this.navigateToThread),this.nav.on("thread:removed",this.navigateToAllThreads),this.nav.on("threads:rendered",this.setActiveThread),this.nav.on("thread:created",this.navigateToThread),this.nav.render(),this.newPost=$(".new-post-article"),this.newPostView=new NewPostView({el:this.newPost,collection:this.discussion,course_settings:this.course_settings,mode:"tab"}),this.newPostView.render(),this.listenTo(this.newPostView,"newPost:cancel",this.hideNewPost),$(".new-post-btn").bind("click",this.showNewPost),$(".new-post-btn").bind("keydown",function(event){return DiscussionUtil.activateOnSpace(event,_this.showNewPost)})},DiscussionRouter.prototype.allThreads=function(){return this.nav.updateSidebar(),this.nav.goHome()},DiscussionRouter.prototype.setActiveThread=function(){return this.thread?this.nav.setActiveThread(this.thread.get("id")):this.nav.goHome},DiscussionRouter.prototype.showThread=function(forum_name,thread_id){return this.thread=this.discussion.get(thread_id),this.thread.set("unread_comments_count",0),this.thread.set("read",!0),this.setActiveThread(),this.showMain()},DiscussionRouter.prototype.showMain=function(){var _this=this;return this.main&&(this.main.cleanup(),this.main.undelegateEvents()),$(".forum-content").is(":visible")||$(".forum-content").fadeIn(),this.newPost.is(":visible")&&this.newPost.fadeOut(),this.main=new DiscussionThreadView({el:$(".forum-content"),model:this.thread,mode:"tab",course_settings:this.course_settings}),this.main.render(),this.main.on("thread:responses:rendered",function(){return _this.nav.updateSidebar()}),this.thread.on("thread:thread_type_updated",this.showMain)},DiscussionRouter.prototype.navigateToThread=function(thread_id){var thread;return thread=this.discussion.get(thread_id),this.navigate(""+thread.get("commentable_id")+"/threads/"+thread_id,{trigger:!0})},DiscussionRouter.prototype.navigateToAllThreads=function(){return this.navigate("",{trigger:!0})},DiscussionRouter.prototype.showNewPost=function(){var _this=this;return $(".forum-content").fadeOut({duration:200,complete:function(){return _this.newPost.fadeIn(200),$(".new-post-title").focus()}})},DiscussionRouter.prototype.hideNewPost=function(){return this.newPost.fadeOut({duration:200,complete:function(){return $(".forum-content").fadeIn(200)}})},DiscussionRouter}(Backbone.Router))}.call(this),function(){var DiscussionApp,DiscussionProfileApp;"undefined"!=typeof Backbone&&null!==Backbone&&(DiscussionApp={start:function(elem){var content_info,course_settings,discussion,element,sort_preference,thread_pages,threads,user,user_info;return DiscussionUtil.loadRolesFromContainer(),element=$(elem),window.$$course_id=element.data("course-id"),user_info=element.data("user-info"),sort_preference=element.data("sort-preference"),threads=element.data("threads"),thread_pages=element.data("thread-pages"),content_info=element.data("content-info"),user=new DiscussionUser(user_info),DiscussionUtil.setUser(user),window.user=user,Content.loadContentInfos(content_info),discussion=new Discussion(threads,{pages:thread_pages,sort:sort_preference}),course_settings=new DiscussionCourseSettings(element.data("course-settings")),new DiscussionRouter({discussion:discussion,course_settings:course_settings}),Backbone.history.start({pushState:!0,root:"/courses/"+$$course_id+"/discussion/forum/"})}},DiscussionProfileApp={start:function(elem){var element,numPages,page,threads,user_info;return DiscussionUtil.loadRoles({Moderator:[],Administrator:[],"Community TA":[]}),element=$(elem),window.$$course_id=element.data("course-id"),threads=element.data("threads"),user_info=element.data("user-info"),window.user=new DiscussionUser(user_info),page=element.data("page"),numPages=element.data("num-pages"),new DiscussionUserProfileView({el:element,collection:threads,page:page,numPages:numPages})}},$(function(){return $("section.discussion").each(function(index,elem){return DiscussionApp.start(elem)}),$("section.discussion-user-threads").each(function(index,elem){return DiscussionProfileApp.start(elem)})}))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionCourseSettings=function(_super){function DiscussionCourseSettings(){return DiscussionCourseSettings.__super__.constructor.apply(this,arguments)}return __extends(DiscussionCourseSettings,_super),DiscussionCourseSettings}(Backbone.Model))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionUser=function(_super){function DiscussionUser(){return DiscussionUser.__super__.constructor.apply(this,arguments)}return __extends(DiscussionUser,_super),DiscussionUser.prototype.following=function(thread){return _.include(this.get("subscribed_thread_ids"),thread.id)},DiscussionUser.prototype.voted=function(thread){return _.include(this.get("upvoted_ids"),thread.id)},DiscussionUser.prototype.vote=function(thread){return this.get("upvoted_ids").push(thread.id),thread.vote()},DiscussionUser.prototype.unvote=function(thread){return this.set("upvoted_ids",_.without(this.get("upvoted_ids"),thread.id)),thread.unvote()},DiscussionUser}(Backbone.Model))}.call(this),function(){}.call(this),function(){$(function(){return window.$$contents||(window.$$contents={}),$.fn.extend({loading:function(takeFocus){return this.$_loading=$("<div class='loading-animation' tabindex='0'><span class='sr'>"+gettext("Loading content")+"</span></div>"),$(this).after(this.$_loading),takeFocus?(DiscussionUtil.makeFocusTrap(this.$_loading),this.$_loading.focus()):void 0},loaded:function(){return this.$_loading.remove()}})}),this.DiscussionUtil=function(){function DiscussionUtil(){}return DiscussionUtil.wmdEditors={},DiscussionUtil.getTemplate=function(id){return $("script#"+id).html()},DiscussionUtil.setUser=function(user){return this.user=user},DiscussionUtil.getUser=function(){return this.user},DiscussionUtil.loadRoles=function(roles){return this.roleIds=roles},DiscussionUtil.loadRolesFromContainer=function(){return this.loadRoles($("#discussion-container").data("roles"))},DiscussionUtil.isStaff=function(user_id){var staff,_ref;return null==user_id&&(user_id=null!=(_ref=this.user)?_ref.id:void 0),staff=_.union(this.roleIds.Moderator,this.roleIds.Administrator),_.include(staff,parseInt(user_id))},DiscussionUtil.isTA=function(user_id){var ta,_ref;return null==user_id&&(user_id=null!=(_ref=this.user)?_ref.id:void 0),ta=_.union(this.roleIds["Community TA"]),_.include(ta,parseInt(user_id))},DiscussionUtil.isPrivilegedUser=function(user_id){return this.isStaff(user_id)||this.isTA(user_id)},DiscussionUtil.bulkUpdateContentInfo=function(infos){var id,info,_results;_results=[];for(id in infos)info=infos[id],_results.push(Content.getContent(id).updateInfo(info));return _results},DiscussionUtil.generateDiscussionLink=function(cls,txt,handler){return $("<a>").addClass("discussion-link").attr("href","javascript:void(0)").addClass(cls).html(txt).click(function(){return handler(this)})},DiscussionUtil.urlFor=function(name,param,param1,param2){return{follow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/follow",unfollow_discussion:"/courses/"+$$course_id+"/discussion/"+param+"/unfollow",create_thread:"/courses/"+$$course_id+"/discussion/"+param+"/threads/create",update_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/update",create_comment:"/courses/"+$$course_id+"/discussion/threads/"+param+"/reply",delete_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/delete",flagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/flagAbuse",unFlagAbuse_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unFlagAbuse",flagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/flagAbuse",unFlagAbuse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unFlagAbuse",upvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/upvote",downvote_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/downvote",pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/pin",un_pin_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unpin",undo_vote_for_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unvote",follow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/follow",unfollow_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/unfollow",update_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/update",endorse_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/endorse",create_sub_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/reply",delete_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/delete",upvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/upvote",downvote_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/downvote",undo_vote_for_comment:"/courses/"+$$course_id+"/discussion/comments/"+param+"/unvote",upload:"/courses/"+$$course_id+"/discussion/upload",users:"/courses/"+$$course_id+"/discussion/users",search:"/courses/"+$$course_id+"/discussion/forum/search",retrieve_discussion:"/courses/"+$$course_id+"/discussion/forum/"+param+"/inline",retrieve_single_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,openclose_thread:"/courses/"+$$course_id+"/discussion/threads/"+param+"/close",permanent_link_thread:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1,permanent_link_comment:"/courses/"+$$course_id+"/discussion/forum/"+param+"/threads/"+param1+"#"+param2,user_profile:"/courses/"+$$course_id+"/discussion/forum/users/"+param,followed_threads:"/courses/"+$$course_id+"/discussion/forum/users/"+param+"/followed",threads:"/courses/"+$$course_id+"/discussion/forum",enable_notifications:"/notification_prefs/enable/",disable_notifications:"/notification_prefs/disable/",notifications_status:"/notification_prefs/status/"}[name]
},DiscussionUtil.ignoreEnterKey=function(event){return 13===event.which?event.preventDefault():void 0},DiscussionUtil.activateOnSpace=function(event,func){return 32===event.which?(event.preventDefault(),func(event)):void 0},DiscussionUtil.makeFocusTrap=function(elem){return elem.keydown(function(event){return 9===event.which?event.preventDefault():void 0})},DiscussionUtil.discussionAlert=function(header,body){var alertDiv,alertTrigger;return 0===$("#discussion-alert").length&&(alertDiv=$("<div class='modal' role='alertdialog' id='discussion-alert' aria-describedby='discussion-alert-message'/>").css("display","none"),alertDiv.html("<div class='inner-wrapper discussion-alert-wrapper'>  <button class='close-modal dismiss' aria-hidden='true'><i class='icon-remove'></i></button>  <header><h2/><hr/></header>  <p id='discussion-alert-message'/>  <hr/>  <button class='dismiss'>"+gettext("OK")+"</button></div>"),this.makeFocusTrap(alertDiv.find("button")),alertTrigger=$("<a href='#discussion-alert' id='discussion-alert-trigger'/>").css("display","none"),alertTrigger.leanModal({closeButton:"#discussion-alert .dismiss",overlay:1,top:200}),$("body").append(alertDiv).append(alertTrigger)),$("#discussion-alert header h2").html(header),$("#discussion-alert p").html(body),$("#discussion-alert-trigger").click(),$("#discussion-alert button").focus()},DiscussionUtil.safeAjax=function(params){var $elem,request,_this=this;return $elem=params.$elem,$elem&&$elem.attr("disabled")?void 0:(params.url=URI(params.url).addSearch({ajax:1}),params.beforeSend=function(){return $elem&&$elem.attr("disabled","disabled"),params.$loading?null!=params.loadingCallback?params.loadingCallback.apply(params.$loading):params.$loading.loading(params.takeFocus):void 0},params.error||(params.error=function(){return _this.discussionAlert(gettext("Sorry"),gettext("We had some trouble processing your request. Please ensure you have copied any unsaved work and then reload the page."))}),request=$.ajax(params).always(function(){return $elem&&$elem.removeAttr("disabled"),params.$loading?null!=params.loadedCallback?params.loadedCallback.apply(params.$loading):params.$loading.loaded():void 0}))},DiscussionUtil.updateWithUndo=function(model,updates,safeAjaxParams,errorMsg){var undo,_this=this;return errorMsg&&(safeAjaxParams.error=function(){return _this.discussionAlert(gettext("Sorry"),errorMsg)}),undo=_.pick(model.attributes,_.keys(updates)),model.set(updates),this.safeAjax(safeAjaxParams).fail(function(){return model.set(undo)})},DiscussionUtil.bindLocalEvents=function($local,eventsHandler){var event,eventSelector,handler,selector,_ref,_results;_results=[];for(eventSelector in eventsHandler)handler=eventsHandler[eventSelector],_ref=eventSelector.split(" "),event=_ref[0],selector=_ref[1],_results.push($local(selector).unbind(event)[event](handler));return _results},DiscussionUtil.formErrorHandler=function(errorsField){return function(xhr,textStatus,error){var makeErrorElem,response,_i,_len,_ref,_results;if(makeErrorElem=function(message){return $("<li>").addClass("post-error").html(message)},errorsField.empty().show(),400!==xhr.status)return errorsField.append(makeErrorElem(gettext("We had some trouble processing your request. Please try again.")));if(response=JSON.parse(xhr.responseText),null!=response.errors&&response.errors.length>0){for(_ref=response.errors,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)error=_ref[_i],_results.push(errorsField.append(makeErrorElem(error)));return _results}}},DiscussionUtil.clearFormErrors=function(errorsField){return errorsField.empty()},DiscussionUtil.postMathJaxProcessor=function(text){var RE_DISPLAYMATH,RE_INLINEMATH;return RE_INLINEMATH=/^\$([^\$]*)\$/g,RE_DISPLAYMATH=/^\$\$([^\$]*)\$\$/g,this.processEachMathAndCode(text,function(s,type){return"display"===type?s.replace(RE_DISPLAYMATH,function($0,$1){return"\\["+$1+"\\]"}):"inline"===type?s.replace(RE_INLINEMATH,function($0,$1){return"\\("+$1+"\\)"}):s})},DiscussionUtil.makeWmdEditor=function($content,$local,cls_identifier){var appended_id,editor,elem,id,imageUploadUrl,placeholder,_processor;return elem=$local("."+cls_identifier),placeholder=elem.data("placeholder"),id=elem.attr("data-id"),appended_id="-"+cls_identifier+"-"+id,imageUploadUrl=this.urlFor("upload"),_processor=function(_this){return function(text){return _this.postMathJaxProcessor(text)}},editor=Markdown.makeWmdEditor(elem,appended_id,imageUploadUrl,_processor(this)),this.wmdEditors[""+cls_identifier+"-"+id]=editor,null!=placeholder&&elem.find("#wmd-input"+appended_id).attr("placeholder",placeholder),editor},DiscussionUtil.getWmdEditor=function($content,$local,cls_identifier){var elem,id;return elem=$local("."+cls_identifier),id=elem.attr("data-id"),this.wmdEditors[""+cls_identifier+"-"+id]},DiscussionUtil.getWmdInput=function($content,$local,cls_identifier){var elem,id;return elem=$local("."+cls_identifier),id=elem.attr("data-id"),$local("#wmd-input-"+cls_identifier+"-"+id)},DiscussionUtil.getWmdContent=function($content,$local,cls_identifier){return this.getWmdInput($content,$local,cls_identifier).val()},DiscussionUtil.setWmdContent=function($content,$local,cls_identifier,text){return this.getWmdInput($content,$local,cls_identifier).val(text),this.getWmdEditor($content,$local,cls_identifier).refreshPreview()},DiscussionUtil.processEachMathAndCode=function(text,processor){var $div,ESCAPED_BACKSLASH,ESCAPED_DOLLAR,RE_DISPLAYMATH,RE_INLINEMATH,cnt,codeArchive,processedText;for(codeArchive=[],RE_DISPLAYMATH=/^([^\$]*?)\$\$([^\$]*?)\$\$(.*)$/m,RE_INLINEMATH=/^([^\$]*?)\$([^\$]+?)\$(.*)$/m,ESCAPED_DOLLAR="@@ESCAPED_D@@",ESCAPED_BACKSLASH="@@ESCAPED_B@@",processedText="",$div=$("<div>").html(text),$div.find("code").each(function(index,code){return codeArchive.push($(code).html()),$(code).html(codeArchive.length-1)}),text=$div.html(),text=text.replace(/\\\$/g,ESCAPED_DOLLAR);;)if(RE_INLINEMATH.test(text))text=text.replace(RE_INLINEMATH,function($0,$1,$2,$3){return processedText+=$1+processor("$"+$2+"$","inline"),$3});else{if(!RE_DISPLAYMATH.test(text)){processedText+=text;break}text=text.replace(RE_DISPLAYMATH,function($0,$1,$2,$3){return processedText=processor("$$"+$2+"$$","display")+processedText,processedText=$1+processedText,$3})}return text=processedText,text=text.replace(new RegExp(ESCAPED_DOLLAR,"g"),"\\$"),text=text.replace(/\\\\\\\\/g,ESCAPED_BACKSLASH),text=text.replace(/\\begin\{([a-z]*\*?)\}([\s\S]*?)\\end\{\1\}/gim,function($0,$1,$2){return processor("\\begin{"+$1+"}"+$2+("\\end{"+$1+"}"))}),text=text.replace(new RegExp(ESCAPED_BACKSLASH,"g"),"\\\\\\\\"),$div=$("<div>").html(text),cnt=0,$div.find("code").each(function(index,code){return $(code).html(processor(codeArchive[cnt],"code")),cnt+=1}),text=$div.html()},DiscussionUtil.unescapeHighlightTag=function(text){return text.replace(/\&lt\;highlight\&gt\;/g,"<span class='search-highlight'>").replace(/\&lt\;\/highlight\&gt\;/g,"</span>")},DiscussionUtil.stripHighlight=function(text){return text.replace(/\&(amp\;)?lt\;highlight\&(amp\;)?gt\;/g,"").replace(/\&(amp\;)?lt\;\/highlight\&(amp\;)?gt\;/g,"")},DiscussionUtil.stripLatexHighlight=function(text){return this.processEachMathAndCode(text,this.stripHighlight)},DiscussionUtil.markdownWithHighlight=function(text){var converter;return text=text.replace(/^\&gt\;/gm,">"),converter=Markdown.getMathCompatibleConverter(),text=this.unescapeHighlightTag(this.stripLatexHighlight(converter.makeHtml(text))),text.replace(/^>/gm,"&gt;")},DiscussionUtil.abbreviateString=function(text,minLength){if(text.length<minLength)return text;for(;minLength<text.length&&" "!==text[minLength];)minLength++;return text.substr(0,minLength)+gettext("…")},DiscussionUtil.abbreviateHTML=function(html,minLength){var $result,imagesToReplace,truncated_text;return truncated_text=jQuery.truncate(html,{length:minLength,noBreaks:!0,ellipsis:gettext("…")}),$result=$("<div>"+truncated_text+"</div>"),imagesToReplace=$result.find("img:not(:first)"),imagesToReplace.length>0&&$result.append("<p><em>Some images in this post have been omitted</em></p>"),imagesToReplace.replaceWith("<em>image omitted</em>"),$result.html()},DiscussionUtil.getPaginationParams=function(curPage,numPages,pageUrlFunc){var delta,maxPage,minPage,pageInfo,params;return delta=2,minPage=Math.max(curPage-delta,1),maxPage=Math.min(curPage+delta,numPages),pageInfo=function(pageNum){return{number:pageNum,url:pageUrlFunc(pageNum)}},params={page:curPage,lowPages:_.range(minPage,curPage).map(pageInfo),highPages:_.range(curPage+1,maxPage+1).map(pageInfo),previous:curPage>1?pageInfo(curPage-1):null,next:numPages>curPage?pageInfo(curPage+1):null,leftdots:minPage>2,rightdots:numPages-1>maxPage,first:minPage>1?pageInfo(1):null,last:numPages>maxPage?pageInfo(numPages):null}},DiscussionUtil}.call(this)}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionContentView=function(_super){function DiscussionContentView(){var _this=this;return this.setWmdContent=function(){return DiscussionContentView.prototype.setWmdContent.apply(_this,arguments)},this.getWmdContent=function(){return DiscussionContentView.prototype.getWmdContent.apply(_this,arguments)},this.getWmdEditor=function(){return DiscussionContentView.prototype.getWmdEditor.apply(_this,arguments)},this.makeWmdEditor=function(){return DiscussionContentView.prototype.makeWmdEditor.apply(_this,arguments)},DiscussionContentView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionContentView,_super),DiscussionContentView.prototype.events={"click .discussion-flag-abuse":"toggleFlagAbuse","keydown .discussion-flag-abuse":function(event){return DiscussionUtil.activateOnSpace(event,this.toggleFlagAbuse)}},DiscussionContentView.prototype.attrRenderer={ability:function(ability){var action,selector,_ref,_results;_ref=this.abilityRenderer,_results=[];for(action in _ref)selector=_ref[action],_results.push(ability[action]?selector.enable.apply(this):selector.disable.apply(this));return _results}},DiscussionContentView.prototype.abilityRenderer={editable:{enable:function(){return this.$(".action-edit").closest(".actions-item").removeClass("is-hidden")},disable:function(){return this.$(".action-edit").closest(".actions-item").addClass("is-hidden")}},can_delete:{enable:function(){return this.$(".action-delete").closest(".actions-item").removeClass("is-hidden")},disable:function(){return this.$(".action-delete").closest(".actions-item").addClass("is-hidden")}},can_openclose:{enable:function(){var _this=this;return _.each([".action-close",".action-pin"],function(selector){return _this.$(selector).closest(".actions-item").removeClass("is-hidden")})},disable:function(){var _this=this;return _.each([".action-close",".action-pin"],function(selector){return _this.$(selector).closest(".actions-item").addClass("is-hidden")})}}},DiscussionContentView.prototype.renderPartialAttrs=function(){var attr,value,_ref,_results;_ref=this.model.changedAttributes(),_results=[];for(attr in _ref)value=_ref[attr],_results.push(this.attrRenderer[attr]?this.attrRenderer[attr].apply(this,[value]):void 0);return _results},DiscussionContentView.prototype.renderAttrs=function(){var attr,value,_ref,_results;_ref=this.model.attributes,_results=[];for(attr in _ref)value=_ref[attr],_results.push(this.attrRenderer[attr]?this.attrRenderer[attr].apply(this,[value]):void 0);return _results},DiscussionContentView.prototype.makeWmdEditor=function(cls_identifier){return this.$el.find(".wmd-panel").length?void 0:DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)},DiscussionContentView.prototype.getWmdEditor=function(cls_identifier){return DiscussionUtil.getWmdEditor(this.$el,$.proxy(this.$,this),cls_identifier)},DiscussionContentView.prototype.getWmdContent=function(cls_identifier){return DiscussionUtil.getWmdContent(this.$el,$.proxy(this.$,this),cls_identifier)},DiscussionContentView.prototype.setWmdContent=function(cls_identifier,text){return DiscussionUtil.setWmdContent(this.$el,$.proxy(this.$,this),cls_identifier,text)},DiscussionContentView.prototype.initialize=function(){var _this=this;return this.model.bind("change",this.renderPartialAttrs,this),this.listenTo(this.model,"change:endorsed",function(){return _this.model instanceof Comment?_this.trigger("comment:endorse"):void 0})},DiscussionContentView}(Backbone.View),this.DiscussionContentShowView=function(_super){function DiscussionContentShowView(){var _this=this;return this.toggleClose=function(){return DiscussionContentShowView.prototype.toggleClose.apply(_this,arguments)},this.toggleReport=function(){return DiscussionContentShowView.prototype.toggleReport.apply(_this,arguments)},this.togglePin=function(){return DiscussionContentShowView.prototype.togglePin.apply(_this,arguments)},this.toggleVote=function(){return DiscussionContentShowView.prototype.toggleVote.apply(_this,arguments)},this.toggleEndorse=function(){return DiscussionContentShowView.prototype.toggleEndorse.apply(_this,arguments)},this.toggleFollow=function(){return DiscussionContentShowView.prototype.toggleFollow.apply(_this,arguments)},this.handleSecondaryActionBlur=function(){return DiscussionContentShowView.prototype.handleSecondaryActionBlur.apply(_this,arguments)},this.handleSecondaryActionEscape=function(){return DiscussionContentShowView.prototype.handleSecondaryActionEscape.apply(_this,arguments)},this.toggleSecondaryActions=function(){return DiscussionContentShowView.prototype.toggleSecondaryActions.apply(_this,arguments)},this.updateButtonState=function(){return DiscussionContentShowView.prototype.updateButtonState.apply(_this,arguments)},DiscussionContentShowView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionContentShowView,_super),DiscussionContentShowView.prototype.events=_.reduce([[".action-follow","toggleFollow"],[".action-answer","toggleEndorse"],[".action-endorse","toggleEndorse"],[".action-vote","toggleVote"],[".action-more","toggleSecondaryActions"],[".action-pin","togglePin"],[".action-edit","edit"],[".action-delete","_delete"],[".action-report","toggleReport"],[".action-close","toggleClose"]],function(obj,event){var funcName,selector;return selector=event[0],funcName=event[1],obj["click "+selector]=function(event){return this[funcName](event)},obj["keydown "+selector]=function(event){return DiscussionUtil.activateOnSpace(event,this[funcName])},obj},{}),DiscussionContentShowView.prototype.updateButtonState=function(selector,checked){var $button;return $button=this.$(selector),$button.toggleClass("is-checked",checked),$button.attr("aria-checked",checked)},DiscussionContentShowView.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{subscribed:function(subscribed){return this.updateButtonState(".action-follow",subscribed)},endorsed:function(endorsed){var $button,selector;return selector="question"===this.model.get("thread").get("thread_type")?".action-answer":".action-endorse",this.updateButtonState(selector,endorsed),$button=this.$(selector),$button.closest(".actions-item").toggleClass("is-hidden",!this.model.canBeEndorsed()),$button.toggleClass("is-checked",endorsed)},votes:function(votes){var button,numVotes,selector;return selector=".action-vote",this.updateButtonState(selector,window.user.voted(this.model)),button=this.$el.find(selector),numVotes=votes.up_count,button.find(".js-sr-vote-count").html(interpolate(ngettext("currently %(numVotes)s vote","currently %(numVotes)s votes",numVotes),{numVotes:numVotes},!0)),button.find(".js-visual-vote-count").html(interpolate(ngettext("%(numVotes)s Vote","%(numVotes)s Votes",numVotes),{numVotes:numVotes},!0))},pinned:function(pinned){return this.updateButtonState(".action-pin",pinned),this.$(".post-label-pinned").toggleClass("is-hidden",!pinned)},abuse_flaggers:function(){var flagged;return flagged=this.model.isFlagged(),this.updateButtonState(".action-report",flagged),this.$(".post-label-reported").toggleClass("is-hidden",!flagged)},closed:function(closed){return this.updateButtonState(".action-close",closed),this.$(".post-label-closed").toggleClass("is-hidden",!closed)}}),DiscussionContentShowView.prototype.toggleSecondaryActions=function(event){return event.preventDefault(),event.stopPropagation(),this.secondaryActionsExpanded=!this.secondaryActionsExpanded,this.$(".action-more").toggleClass("is-expanded",this.secondaryActionsExpanded),this.$(".actions-dropdown").toggleClass("is-expanded",this.secondaryActionsExpanded).attr("aria-expanded",this.secondaryActionsExpanded),this.secondaryActionsExpanded?("keydown"===event.type&&this.$(".action-list-item:first").focus(),$("body").on("click",this.toggleSecondaryActions),$("body").on("keydown",this.handleSecondaryActionEscape),this.$(".action-list-item").on("blur",this.handleSecondaryActionBlur)):($("body").off("click",this.toggleSecondaryActions),$("body").off("keydown",this.handleSecondaryActionEscape),this.$(".action-list-item").off("blur",this.handleSecondaryActionBlur))},DiscussionContentShowView.prototype.handleSecondaryActionEscape=function(event){return 27===event.keyCode?(this.toggleSecondaryActions(event),this.$(".action-more").focus()):void 0},DiscussionContentShowView.prototype.handleSecondaryActionBlur=function(event){var _this=this;return setTimeout(function(){return _this.secondaryActionsExpanded&&0===_this.$(".actions-dropdown :focus").length?_this.toggleSecondaryActions(event):void 0},10)},DiscussionContentShowView.prototype.toggleFollow=function(event){var is_subscribing,msg,url;return event.preventDefault(),is_subscribing=!this.model.get("subscribed"),url=this.model.urlFor(is_subscribing?"follow":"unfollow"),msg=gettext(is_subscribing?"We had some trouble subscribing you to this thread. Please try again.":"We had some trouble unsubscribing you from this thread. Please try again."),DiscussionUtil.updateWithUndo(this.model,{subscribed:is_subscribing},{url:url,type:"POST",$elem:$(event.currentTarget)},msg)},DiscussionContentShowView.prototype.toggleEndorse=function(event){var beforeFunc,is_endorsing,msg,updates,url,_this=this;return event.preventDefault(),is_endorsing=!this.model.get("endorsed"),url=this.model.urlFor("endorse"),updates={endorsed:is_endorsing,endorsement:is_endorsing?{username:DiscussionUtil.getUser().get("username"),user_id:DiscussionUtil.getUser().id,time:(new Date).toISOString()}:null},msg=gettext("question"===this.model.get("thread").get("thread_type")?is_endorsing?"We had some trouble marking this response as an answer.  Please try again.":"We had some trouble removing this response as an answer.  Please try again.":is_endorsing?"We had some trouble marking this response endorsed.  Please try again.":"We had some trouble removing this endorsement.  Please try again."),beforeFunc=function(){return _this.trigger("comment:endorse")},DiscussionUtil.updateWithUndo(this.model,updates,{url:url,type:"POST",data:{endorsed:is_endorsing},beforeSend:beforeFunc,$elem:$(event.currentTarget)},msg).always(this.trigger("comment:endorse"))},DiscussionContentShowView.prototype.toggleVote=function(event){var is_voting,updates,url,user,_this=this;return event.preventDefault(),user=DiscussionUtil.getUser(),is_voting=!user.voted(this.model),url=this.model.urlFor(is_voting?"upvote":"unvote"),updates={upvoted_ids:(is_voting?_.union:_.difference)(user.get("upvoted_ids"),[this.model.id])},DiscussionUtil.updateWithUndo(user,updates,{url:url,type:"POST",$elem:$(event.currentTarget)},gettext("We had some trouble saving your vote.  Please try again.")).done(function(){return is_voting?_this.model.vote():_this.model.unvote()})},DiscussionContentShowView.prototype.togglePin=function(event){var is_pinning,msg,url;return event.preventDefault(),is_pinning=!this.model.get("pinned"),url=this.model.urlFor(is_pinning?"pinThread":"unPinThread"),msg=gettext(is_pinning?"We had some trouble pinning this thread. Please try again.":"We had some trouble unpinning this thread. Please try again."),DiscussionUtil.updateWithUndo(this.model,{pinned:is_pinning},{url:url,type:"POST",$elem:$(event.currentTarget)},msg)},DiscussionContentShowView.prototype.toggleReport=function(event){var is_flagging,msg,updates,url;return event.preventDefault(),this.model.isFlagged()?(is_flagging=!1,msg=gettext("We had some trouble removing your flag on this post.  Please try again.")):(is_flagging=!0,msg=gettext("We had some trouble reporting this post.  Please try again.")),url=this.model.urlFor(is_flagging?"flagAbuse":"unFlagAbuse"),updates={abuse_flaggers:(is_flagging?_.union:_.difference)(this.model.get("abuse_flaggers"),[DiscussionUtil.getUser().id])},DiscussionUtil.updateWithUndo(this.model,updates,{url:url,type:"POST",$elem:$(event.currentTarget)},msg)},DiscussionContentShowView.prototype.toggleClose=function(event){var is_closing,msg,updates;return event.preventDefault(),is_closing=!this.model.get("closed"),msg=gettext(is_closing?"We had some trouble closing this thread.  Please try again.":"We had some trouble reopening this thread.  Please try again."),updates={closed:is_closing},DiscussionUtil.updateWithUndo(this.model,updates,{url:this.model.urlFor("close"),type:"POST",data:updates,$elem:$(event.currentTarget)},msg)},DiscussionContentShowView.prototype.getAuthorDisplay=function(){return _.template($("#post-user-display-template").html())({username:this.model.get("username")||null,user_url:this.model.get("user_url"),is_community_ta:this.model.get("community_ta_authored"),is_staff:this.model.get("staff_authored")})},DiscussionContentShowView.prototype.getEndorserDisplay=function(){var endorsement;return endorsement=this.model.get("endorsement"),endorsement&&endorsement.username?_.template($("#post-user-display-template").html())({username:endorsement.username,user_url:DiscussionUtil.urlFor("user_profile",endorsement.user_id),is_community_ta:DiscussionUtil.isTA(endorsement.user_id),is_staff:DiscussionUtil.isStaff(endorsement.user_id)}):null},DiscussionContentShowView}.call(this,DiscussionContentView))}.call(this),function(Backbone){"use strict";Backbone&&(this.DiscussionThreadEditView=Backbone.View.extend({tagName:"form",events:{submit:"updateHandler","click .post-cancel":"cancelHandler"},attributes:{"class":"discussion-post edit-post-form"},initialize:function(options){return this.container=options.container||$(".thread-content-wrapper"),this.mode=options.mode||"inline",this.course_settings=options.course_settings,this.threadType=this.model.get("thread_type"),this.topicId=this.model.get("commentable_id"),_.bindAll(this),this},render:function(){var threadTypeTemplate,formId=_.uniqueId("form-");return this.template=_.template($("#thread-edit-template").html()),this.$el.html(this.template(this.model.toJSON())).appendTo(this.container),this.submitBtn=this.$(".post-update"),threadTypeTemplate=_.template($("#thread-type-template").html()),this.addField(threadTypeTemplate({form_id:formId})),this.$("#"+formId+"-post-type-"+this.threadType).attr("checked",!0),this.topicView=new DiscussionTopicMenuView({topicId:this.topicId,course_settings:this.course_settings}),this.addField(this.topicView.render()),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body"),this},addField:function(fieldView){return this.$(".forum-edit-post-form-wrapper").append(fieldView),this},isTabMode:function(){return"tab"===this.mode},save:function(){var title=this.$(".edit-post-title").val(),threadType=this.$(".post-type-input:checked").val(),body=this.$(".edit-post-body textarea").val(),commentableId=this.topicView.getCurrentTopicId(),postData={title:title,thread_type:threadType,body:body,commentable_id:commentableId};return DiscussionUtil.safeAjax({$elem:this.submitBtn,$loading:this.submitBtn,url:DiscussionUtil.urlFor("update_thread",this.model.id),type:"POST",dataType:"json",async:!1,data:postData,error:DiscussionUtil.formErrorHandler(this.$(".post-errors")),success:function(){this.$(".edit-post-title").val("").attr("prev-text",""),this.$(".edit-post-body textarea").val("").attr("prev-text",""),this.$(".wmd-preview p").html(""),postData.courseware_title=this.topicView.getFullTopicName(),this.model.set(postData).unset("abbreviatedBody"),this.trigger("thread:updated"),this.threadType!==threadType&&(this.model.set("thread_type",threadType),this.model.trigger("thread:thread_type_updated"),this.trigger("comment:endorse"))}.bind(this)})},updateHandler:function(event){return event.preventDefault(),this.trigger("thread:update",event),this.save(),this},cancelHandler:function(event){return event.preventDefault(),this.trigger("thread:cancel_edit",event),this.remove(),this}}))}.call(this,Backbone),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadListView=function(_super){function DiscussionThreadListView(){var _this=this;return this.updateEmailNotifications=function(){return DiscussionThreadListView.prototype.updateEmailNotifications.apply(_this,arguments)},this.retrieveFollowed=function(){return DiscussionThreadListView.prototype.retrieveFollowed.apply(_this,arguments)},this.chooseCohort=function(){return DiscussionThreadListView.prototype.chooseCohort.apply(_this,arguments)},this.chooseFilter=function(){return DiscussionThreadListView.prototype.chooseFilter.apply(_this,arguments)},this.filterTopics=function(){return DiscussionThreadListView.prototype.filterTopics.apply(_this,arguments)},this.toggleBrowseMenu=function(){return DiscussionThreadListView.prototype.toggleBrowseMenu.apply(_this,arguments)},this.hideBrowseMenu=function(){return DiscussionThreadListView.prototype.hideBrowseMenu.apply(_this,arguments)},this.showBrowseMenu=function(){return DiscussionThreadListView.prototype.showBrowseMenu.apply(_this,arguments)},this.isBrowseMenuVisible=function(){return DiscussionThreadListView.prototype.isBrowseMenuVisible.apply(_this,arguments)},this.threadRemoved=function(){return DiscussionThreadListView.prototype.threadRemoved.apply(_this,arguments)},this.threadSelected=function(){return DiscussionThreadListView.prototype.threadSelected.apply(_this,arguments)},this.renderThread=function(){return DiscussionThreadListView.prototype.renderThread.apply(_this,arguments)},this.loadMorePages=function(){return DiscussionThreadListView.prototype.loadMorePages.apply(_this,arguments)},this.showMetadataAccordingToSort=function(){return DiscussionThreadListView.prototype.showMetadataAccordingToSort.apply(_this,arguments)},this.renderThreads=function(){return DiscussionThreadListView.prototype.renderThreads.apply(_this,arguments)},this.updateSidebar=function(){return DiscussionThreadListView.prototype.updateSidebar.apply(_this,arguments)},this.addAndSelectThread=function(){return DiscussionThreadListView.prototype.addAndSelectThread.apply(_this,arguments)},this.reloadDisplayedCollection=function(){return DiscussionThreadListView.prototype.reloadDisplayedCollection.apply(_this,arguments)},this.clearSearchAlerts=function(){return DiscussionThreadListView.prototype.clearSearchAlerts.apply(_this,arguments)},this.removeSearchAlert=function(){return DiscussionThreadListView.prototype.removeSearchAlert.apply(_this,arguments)},this.addSearchAlert=function(){return DiscussionThreadListView.prototype.addSearchAlert.apply(_this,arguments)},DiscussionThreadListView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionThreadListView,_super),DiscussionThreadListView.prototype.events={"click .forum-nav-browse":"toggleBrowseMenu","keypress .forum-nav-browse-filter-input":function(event){return DiscussionUtil.ignoreEnterKey(event)},"keyup .forum-nav-browse-filter-input":"filterTopics","click .forum-nav-browse-menu-wrapper":"ignoreClick","click .forum-nav-browse-title":"selectTopicHandler","keydown .forum-nav-search-input":"performSearch","click .icon-search":"performSearch","change .forum-nav-sort-control":"sortThreads","click .forum-nav-thread-link":"threadSelected","click .forum-nav-load-more-link":"loadMorePages","change .forum-nav-filter-main-control":"chooseFilter","change .forum-nav-filter-cohort-control":"chooseCohort"},DiscussionThreadListView.prototype.initialize=function(options){var _this=this;return this.courseSettings=options.courseSettings,this.displayedCollection=new Discussion(this.collection.models,{pages:this.collection.pages}),this.collection.on("change",this.reloadDisplayedCollection),this.discussionIds="",this.collection.on("reset",function(discussion){var board;return board=$(".current-board").html(),_this.displayedCollection.current_page=discussion.current_page,_this.displayedCollection.pages=discussion.pages,_this.displayedCollection.reset(discussion.models)}),this.collection.on("add",this.addAndSelectThread),this.sidebar_padding=10,this.boardName,this.template=_.template($("#thread-list-template").html()),this.current_search="",this.mode="all",this.searchAlertCollection=new Backbone.Collection([],{model:Backbone.Model}),this.searchAlertCollection.on("add",function(searchAlert){var content;return content=_.template($("#search-alert-template").html(),{message:searchAlert.attributes.message,cid:searchAlert.cid}),_this.$(".search-alerts").append(content),_this.$("#search-alert-"+searchAlert.cid+" a.dismiss").bind("click",searchAlert,function(event){return _this.removeSearchAlert(event.data.cid)})}),this.searchAlertCollection.on("remove",function(searchAlert){return _this.$("#search-alert-"+searchAlert.cid).remove()}),this.searchAlertCollection.on("reset",function(){return _this.$(".search-alerts").empty()})},DiscussionThreadListView.prototype.addSearchAlert=function(message){var m;return m=new Backbone.Model({message:message}),this.searchAlertCollection.add(m),m},DiscussionThreadListView.prototype.removeSearchAlert=function(searchAlert){return this.searchAlertCollection.remove(searchAlert)},DiscussionThreadListView.prototype.clearSearchAlerts=function(){return this.searchAlertCollection.reset()},DiscussionThreadListView.prototype.reloadDisplayedCollection=function(thread){var active,content,current_el,thread_id;return this.clearSearchAlerts(),thread_id=thread.get("id"),content=this.renderThread(thread),current_el=this.$(".forum-nav-thread[data-id="+thread_id+"]"),active=0!==current_el.has(".forum-nav-thread-link.is-active").length,current_el.replaceWith(content),this.showMetadataAccordingToSort(),active?this.setActiveThread(thread_id):void 0},DiscussionThreadListView.prototype.addAndSelectThread=function(thread){var commentable_id,menuItem,_this=this;return commentable_id=thread.get("commentable_id"),menuItem=this.$(".forum-nav-browse-menu-item[data-discussion-id]").filter(function(){return $(this).data("discussion-id")===commentable_id}),this.setCurrentTopicDisplay(this.getPathText(menuItem)),this.retrieveDiscussion(commentable_id,function(){return _this.trigger("thread:created",thread.get("id"))})},DiscussionThreadListView.prototype.updateSidebar=function(){var amount,browseFilterHeight,discussionBody,discussionBottomOffset,discussionsBodyBottom,discussionsBodyTop,headerHeight,refineBarHeight,scrollTop,sidebar,sidebarHeight,topOffset,windowHeight;return scrollTop=$(window).scrollTop(),windowHeight=$(window).height(),discussionBody=$(".discussion-column"),discussionsBodyTop=discussionBody[0]?discussionBody.offset().top:void 0,discussionsBodyBottom=discussionsBodyTop+discussionBody.outerHeight(),sidebar=$(".forum-nav"),scrollTop>discussionsBodyTop-this.sidebar_padding?sidebar.css("top",scrollTop-discussionsBodyTop+this.sidebar_padding):sidebar.css("top","0"),sidebarHeight=windowHeight-Math.max(discussionsBodyTop-scrollTop,this.sidebar_padding),topOffset=scrollTop+windowHeight,discussionBottomOffset=discussionsBodyBottom+this.sidebar_padding,amount=Math.max(topOffset-discussionBottomOffset,0),sidebarHeight=sidebarHeight-this.sidebar_padding-amount,sidebarHeight=Math.min(sidebarHeight+1,discussionBody.outerHeight()),sidebar.css("height",sidebarHeight),headerHeight=this.$(".forum-nav-header").outerHeight(),refineBarHeight=this.$(".forum-nav-refine-bar").outerHeight(),browseFilterHeight=this.$(".forum-nav-browse-filter").outerHeight(),this.$(".forum-nav-thread-list").css("height",sidebarHeight-headerHeight-refineBarHeight-2+"px"),this.$(".forum-nav-browse-menu").css("height",sidebarHeight-headerHeight-browseFilterHeight-2+"px")
},DiscussionThreadListView.prototype.ignoreClick=function(event){return event.stopPropagation()},DiscussionThreadListView.prototype.render=function(){var _this=this;return this.timer=0,this.$el.html(this.template({isCohorted:this.courseSettings.get("is_cohorted"),isPrivilegedUser:DiscussionUtil.isPrivilegedUser()})),this.$(".forum-nav-sort-control").val(this.collection.sort_preference),$(window).bind("load scroll resize",this.updateSidebar),this.displayedCollection.on("reset",this.renderThreads),this.displayedCollection.on("thread:remove",this.renderThreads),this.displayedCollection.on("change:commentable_id",function(){return"commentables"===_this.mode?_this.retrieveDiscussions(_this.discussionIds.split(",")):void 0}),this.renderThreads(),this},DiscussionThreadListView.prototype.renderThreads=function(){var content,rendered,thread,_i,_len,_ref;for(this.$(".forum-nav-thread-list").html(""),rendered=$("<div></div>"),_ref=this.displayedCollection.models,_i=0,_len=_ref.length;_len>_i;_i++)thread=_ref[_i],content=this.renderThread(thread),rendered.append(content);return this.$(".forum-nav-thread-list").html(rendered.html()),this.showMetadataAccordingToSort(),this.renderMorePages(),this.updateSidebar(),this.trigger("threads:rendered")},DiscussionThreadListView.prototype.showMetadataAccordingToSort=function(){var commentCounts,voteCounts;switch(voteCounts=this.$(".forum-nav-thread-votes-count"),commentCounts=this.$(".forum-nav-thread-comments-count"),voteCounts.hide(),commentCounts.hide(),this.$(".forum-nav-sort-control").val()){case"date":case"comments":return commentCounts.show();case"votes":return voteCounts.show()}},DiscussionThreadListView.prototype.renderMorePages=function(){return this.displayedCollection.hasMorePages()?this.$(".forum-nav-thread-list").append("<li class='forum-nav-load-more'><a href='#' class='forum-nav-load-more-link'>"+gettext("Load more")+"</a></li>"):void 0},DiscussionThreadListView.prototype.getLoadingContent=function(srText){return'<div class="forum-nav-loading" tabindex="0"><span class="icon-spinner icon-spin"/><span class="sr" role="alert">'+srText+"</span></div>"},DiscussionThreadListView.prototype.loadMorePages=function(event){var error,lastThread,loadMoreElem,loadingElem,options,_ref,_this=this;switch(event&&event.preventDefault(),loadMoreElem=this.$(".forum-nav-load-more"),loadMoreElem.html(this.getLoadingContent(gettext("Loading more threads"))),loadingElem=loadMoreElem.find(".forum-nav-loading"),DiscussionUtil.makeFocusTrap(loadingElem),loadingElem.focus(),options={filter:this.filter},this.mode){case"search":options.search_text=this.current_search,this.group_id&&(options.group_id=this.group_id);break;case"followed":options.user_id=window.user.id;break;case"commentables":options.commentable_ids=this.discussionIds,this.group_id&&(options.group_id=this.group_id);break;case"all":this.group_id&&(options.group_id=this.group_id)}return lastThread=null!=(_ref=this.collection.last())?_ref.get("id"):void 0,lastThread?this.once("threads:rendered",function(){return $(".forum-nav-thread[data-id='"+lastThread+"'] + .forum-nav-thread .forum-nav-thread-link").focus()}):this.once("threads:rendered",function(){var _ref1;return null!=(_ref1=$(".forum-nav-thread-link").first())?_ref1.focus():void 0}),error=function(){return _this.renderThreads(),DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more threads. Please try again."))},this.collection.retrieveAnotherPage(this.mode,options,{sort_key:this.$(".forum-nav-sort-control").val()},error)},DiscussionThreadListView.prototype.renderThread=function(thread){var content,unreadCount;return content=$(_.template($("#thread-list-item-template").html())(thread.toJSON())),unreadCount=thread.get("unread_comments_count")+(thread.get("read")?0:1),unreadCount>0&&content.find(".forum-nav-thread-comments-count").attr("data-tooltip",interpolate(ngettext("%(unread_count)s new comment","%(unread_count)s new comments",unreadCount),{unread_count:unreadCount},!0)),content},DiscussionThreadListView.prototype.threadSelected=function(e){var thread_id;return thread_id=$(e.target).closest(".forum-nav-thread").attr("data-id"),this.setActiveThread(thread_id),this.trigger("thread:selected",thread_id),!1},DiscussionThreadListView.prototype.threadRemoved=function(thread_id){return this.trigger("thread:removed",thread_id)},DiscussionThreadListView.prototype.setActiveThread=function(thread_id){return this.$(".forum-nav-thread[data-id!='"+thread_id+"'] .forum-nav-thread-link").removeClass("is-active"),this.$(".forum-nav-thread[data-id='"+thread_id+"'] .forum-nav-thread-link").addClass("is-active")},DiscussionThreadListView.prototype.goHome=function(){var thread_id,url;return this.template=_.template($("#discussion-home").html()),$(".forum-content").html(this.template),$(".forum-nav-thread-list a").removeClass("is-active"),$("input.email-setting").bind("click",this.updateEmailNotifications),url=DiscussionUtil.urlFor("notifications_status",window.user.get("id")),DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response){return response.status?$("input.email-setting").attr("checked","checked"):$("input.email-setting").removeAttr("checked")}}),thread_id=null,this.trigger("thread:removed")},DiscussionThreadListView.prototype.isBrowseMenuVisible=function(){return this.$(".forum-nav-browse-menu-wrapper").is(":visible")},DiscussionThreadListView.prototype.showBrowseMenu=function(){return this.isBrowseMenuVisible()?void 0:(this.$(".forum-nav-browse").addClass("is-active"),this.$(".forum-nav-browse-menu-wrapper").show(),this.$(".forum-nav-thread-list-wrapper").hide(),$(".forum-nav-browse-filter-input").focus(),$("body").bind("click",this.hideBrowseMenu),this.updateSidebar())},DiscussionThreadListView.prototype.hideBrowseMenu=function(){return this.isBrowseMenuVisible()?(this.$(".forum-nav-browse").removeClass("is-active"),this.$(".forum-nav-browse-menu-wrapper").hide(),this.$(".forum-nav-thread-list-wrapper").show(),$("body").unbind("click",this.hideBrowseMenu),this.updateSidebar()):void 0},DiscussionThreadListView.prototype.toggleBrowseMenu=function(event){return event.preventDefault(),event.stopPropagation(),this.isBrowseMenuVisible()?this.hideBrowseMenu():this.showBrowseMenu()},DiscussionThreadListView.prototype.getPathText=function(item){var path,pathText,pathTitles;return path=item.parents(".forum-nav-browse-menu-item").andSelf(),pathTitles=path.children(".forum-nav-browse-title").map(function(i,elem){return $(elem).text()}).get(),pathText=pathTitles.join(" / ")},DiscussionThreadListView.prototype.filterTopics=function(event){var items,query,_this=this;return query=$(event.target).val(),items=this.$(".forum-nav-browse-menu-item"),0===query.length?items.show():(items.hide(),items.each(function(i,item){var path,pathText;return item=$(item),!item.is(":visible")&&(pathText=_this.getPathText(item).toLowerCase(),query.split(" ").every(function(term){return-1!==pathText.search(term.toLowerCase())}))?(path=item.parents(".forum-nav-browse-menu-item").andSelf(),path.add(item.find(".forum-nav-browse-menu-item")).show()):void 0}))},DiscussionThreadListView.prototype.setCurrentTopicDisplay=function(text){return this.$(".forum-nav-browse-current").text(this.fitName(text))},DiscussionThreadListView.prototype.getNameWidth=function(name){var test,width;return test=$("<div>"),test.css({"font-size":this.$(".forum-nav-browse-current").css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3}),$("body").append(test),test.html(name),width=test.width(),test.remove(),width},DiscussionThreadListView.prototype.fitName=function(name){var partialName,path,prefix,rawName,width,x;if(this.maxNameWidth=this.$(".forum-nav-browse").width()-parseInt(this.$(".forum-nav-browse").css("padding-left"))-parseInt(this.$(".forum-nav-browse").css("padding-right"))-this.$(".forum-nav-browse .icon").outerWidth(!0)-this.$(".forum-nav-browse-drop-arrow").outerWidth(!0),width=this.getNameWidth(name),width<this.maxNameWidth)return name;for(path=function(){var _i,_len,_ref,_results;for(_ref=name.split("/"),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)x=_ref[_i],_results.push(x.replace(/^\s+|\s+$/g,""));return _results}(),prefix="";path.length>1;)if(prefix=gettext("…")+"/",path.shift(),partialName=prefix+path.join("/"),this.getNameWidth(partialName)<this.maxNameWidth)return partialName;for(rawName=path[0],name=prefix+rawName;this.getNameWidth(name)>this.maxNameWidth;)rawName=rawName.slice(0,rawName.length-1),name=prefix+rawName+gettext("…");return name},DiscussionThreadListView.prototype.selectTopicHandler=function(event){return event.preventDefault(),this.selectTopic($(event.target))},DiscussionThreadListView.prototype.selectTopic=function($target){var allItems,discussionIds,item;return this.hideBrowseMenu(),this.clearSearch(),item=$target.closest(".forum-nav-browse-menu-item"),this.setCurrentTopicDisplay(this.getPathText(item)),item.hasClass("forum-nav-browse-menu-all")?(this.discussionIds="",this.$(".forum-nav-filter-cohort").show(),this.retrieveAllThreads()):item.hasClass("forum-nav-browse-menu-following")?(this.retrieveFollowed(),this.$(".forum-nav-filter-cohort").hide()):(allItems=item.find(".forum-nav-browse-menu-item").andSelf(),discussionIds=allItems.filter("[data-discussion-id]").map(function(i,elem){return $(elem).data("discussion-id")}).get(),this.retrieveDiscussions(discussionIds),this.$(".forum-nav-filter-cohort").toggle(item.data("cohorted")===!0))},DiscussionThreadListView.prototype.chooseFilter=function(){return this.filter=$(".forum-nav-filter-main-control :selected").val(),this.retrieveFirstPage()},DiscussionThreadListView.prototype.chooseCohort=function(){return this.group_id=this.$(".forum-nav-filter-cohort-control :selected").val(),this.retrieveFirstPage()},DiscussionThreadListView.prototype.retrieveDiscussion=function(discussion_id,callback){var url,_this=this;return null==callback&&(callback=null),url=DiscussionUtil.urlFor("retrieve_discussion",discussion_id),DiscussionUtil.safeAjax({url:url,type:"GET",success:function(response){return _this.collection.current_page=response.page,_this.collection.pages=response.num_pages,_this.collection.reset(response.discussion_data),Content.loadContentInfos(response.annotated_content_info),_this.displayedCollection.reset(_this.collection.models),null!=callback?callback():void 0}})},DiscussionThreadListView.prototype.retrieveDiscussions=function(discussion_ids){return this.discussionIds=discussion_ids.join(","),this.mode="commentables",this.retrieveFirstPage()},DiscussionThreadListView.prototype.retrieveAllThreads=function(){return this.mode="all",this.retrieveFirstPage()},DiscussionThreadListView.prototype.retrieveFirstPage=function(event){return this.collection.current_page=0,this.collection.reset(),this.loadMorePages(event)},DiscussionThreadListView.prototype.sortThreads=function(event){return this.displayedCollection.setSortComparator(this.$(".forum-nav-sort-control").val()),this.retrieveFirstPage(event)},DiscussionThreadListView.prototype.performSearch=function(event){var text;return 13===event.which||"click"===event.type?(event.preventDefault(),this.hideBrowseMenu(),this.setCurrentTopicDisplay(gettext("Search Results")),text=this.$(".forum-nav-search-input").val(),this.searchFor(text)):void 0},DiscussionThreadListView.prototype.searchFor=function(text){var url,_this=this;return this.clearSearchAlerts(),this.clearFilters(),this.mode="search",this.current_search=text,url=DiscussionUtil.urlFor("search"),DiscussionUtil.safeAjax({$elem:this.$(".forum-nav-search-input"),data:{text:text},url:url,type:"GET",dataType:"json",$loading:$,loadingCallback:function(){return _this.$(".forum-nav-thread-list").html("<li class='forum-nav-load-more'>"+_this.getLoadingContent(gettext("Loading thread list"))+"</li>")},loadedCallback:function(){return _this.$(".forum-nav-thread-list .forum-nav-load-more").remove()},success:function(response,textStatus){var message;return"success"===textStatus&&(_this.collection.reset(response.discussion_data),Content.loadContentInfos(response.annotated_content_info),_this.collection.current_page=response.page,_this.collection.pages=response.num_pages,_.isNull(response.corrected_text)?0===response.discussion_data.length&&_this.addSearchAlert(gettext("No threads matched your query.")):(message=interpolate(_.escape(gettext("No results found for %(original_query)s. Showing results for %(suggested_query)s.")),{original_query:"<em>"+_.escape(text)+"</em>",suggested_query:"<em>"+response.corrected_text+"</em>"},!0),_this.addSearchAlert(message)),_this.displayedCollection.reset(_this.collection.models),text)?_this.searchForUser(text):void 0}})},DiscussionThreadListView.prototype.searchForUser=function(text){var _this=this;return DiscussionUtil.safeAjax({data:{username:text},url:DiscussionUtil.urlFor("users"),type:"GET",dataType:"json",error:function(){},success:function(response){var message;return response.users.length>0?(message=interpolate(_.escape(gettext("Show posts by %(username)s.")),{username:_.template('<a class="link-jump" href="<%= url %>"><%- username %></a>',{url:DiscussionUtil.urlFor("user_profile",response.users[0].id),username:response.users[0].username})},!0),_this.addSearchAlert(message)):void 0}})},DiscussionThreadListView.prototype.clearSearch=function(){return this.$(".forum-nav-search-input").val(""),this.current_search="",this.clearSearchAlerts()},DiscussionThreadListView.prototype.clearFilters=function(){return this.$(".forum-nav-filter-main-control").val("all"),this.$(".forum-nav-filter-cohort-control").val("all")},DiscussionThreadListView.prototype.retrieveFollowed=function(){return this.mode="followed",this.retrieveFirstPage()},DiscussionThreadListView.prototype.updateEmailNotifications=function(){return DiscussionUtil.safeAjax($("input.email-setting").attr("checked")?{url:DiscussionUtil.urlFor("enable_notifications"),type:"POST",error:function(){return $("input.email-setting").removeAttr("checked")}}:{url:DiscussionUtil.urlFor("disable_notifications"),type:"POST",error:function(){return $("input.email-setting").attr("checked","checked")}})},DiscussionThreadListView}.call(this,Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadProfileView=function(_super){function DiscussionThreadProfileView(){return DiscussionThreadProfileView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionThreadProfileView,_super),DiscussionThreadProfileView.prototype.render=function(){var element,params;return this.template=DiscussionUtil.getTemplate("_profile_thread"),this.convertMath(),this.abbreviateBody(),params=$.extend(this.model.toJSON(),{permalink:this.model.urlFor("retrieve")}),this.model.get("anonymous")||(params=$.extend(params,{user:{username:this.model.username,user_url:this.model.user_url}})),this.$el.html(Mustache.render(this.template,params)),this.$("span.timeago").timeago(),element=this.$(".post-body"),MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]]),this},DiscussionThreadProfileView.prototype.convertMath=function(){return this.model.set("markdownBody",DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(this.model.get("body"))))},DiscussionThreadProfileView.prototype.abbreviateBody=function(){var abbreviated;return abbreviated=DiscussionUtil.abbreviateHTML(this.model.get("markdownBody"),140),this.model.set("abbreviatedBody",abbreviated)},DiscussionThreadProfileView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadShowView=function(_super){function DiscussionThreadShowView(){return DiscussionThreadShowView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionThreadShowView,_super),DiscussionThreadShowView.prototype.initialize=function(options){var _ref;if(DiscussionThreadShowView.__super__.initialize.call(this),this.mode=options.mode||"inline","tab"!==(_ref=this.mode)&&"inline"!==_ref)throw new Error("invalid mode: "+this.mode)},DiscussionThreadShowView.prototype.renderTemplate=function(){var context;return this.template=_.template($("#thread-show-template").html()),context=$.extend({mode:this.mode,flagged:this.model.isFlagged(),author_display:this.getAuthorDisplay(),cid:this.model.cid},this.model.attributes),this.template(context)},DiscussionThreadShowView.prototype.render=function(){return this.$el.html(this.renderTemplate()),this.delegateEvents(),this.renderAttrs(),this.$("span.timeago").timeago(),this.convertMath(),this.highlight(this.$(".post-body")),this.highlight(this.$("h1,h3")),this},DiscussionThreadShowView.prototype.convertMath=function(){var element;return element=this.$(".post-body"),element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text()))),MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])},DiscussionThreadShowView.prototype.edit=function(event){return this.trigger("thread:edit",event)},DiscussionThreadShowView.prototype._delete=function(event){return this.trigger("thread:_delete",event)},DiscussionThreadShowView.prototype.highlight=function(el){return el.html()?el.html(el.html().replace(/&lt;mark&gt;/g,"<mark>").replace(/&lt;\/mark&gt;/g,"</mark>")):void 0},DiscussionThreadShowView}(DiscussionContentShowView))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionThreadView=function(_super){function DiscussionThreadView(){var _this=this;return this._delete=function(){return DiscussionThreadView.prototype._delete.apply(_this,arguments)},this.closeEditView=function(){return DiscussionThreadView.prototype.closeEditView.apply(_this,arguments)},this.edit=function(){return DiscussionThreadView.prototype.edit.apply(_this,arguments)},this.endorseThread=function(){return DiscussionThreadView.prototype.endorseThread.apply(_this,arguments)},this.addComment=function(){return DiscussionThreadView.prototype.addComment.apply(_this,arguments)},this.renderAddResponseButton=function(){return DiscussionThreadView.prototype.renderAddResponseButton.apply(_this,arguments)},this.renderResponseToList=function(){return DiscussionThreadView.prototype.renderResponseToList.apply(_this,arguments)},this.renderResponseCountAndPagination=function(){return DiscussionThreadView.prototype.renderResponseCountAndPagination.apply(_this,arguments)},DiscussionThreadView.__super__.constructor.apply(this,arguments)}var INITIAL_RESPONSE_PAGE_SIZE,SUBSEQUENT_RESPONSE_PAGE_SIZE;return __extends(DiscussionThreadView,_super),INITIAL_RESPONSE_PAGE_SIZE=25,SUBSEQUENT_RESPONSE_PAGE_SIZE=100,DiscussionThreadView.prototype.events={"click .discussion-submit-post":"submitComment","click .add-response-btn":"scrollToAddResponse","click .forum-thread-expand":"expand","click .forum-thread-collapse":"collapse"},DiscussionThreadView.prototype.$=function(selector){return this.$el.find(selector)},DiscussionThreadView.prototype.isQuestion=function(){return"question"===this.model.get("thread_type")},DiscussionThreadView.prototype.initialize=function(options){var _ref,_this=this;if(DiscussionThreadView.__super__.initialize.call(this),this.mode=options.mode||"inline","tab"!==(_ref=this.mode)&&"inline"!==_ref)throw new Error("invalid mode: "+this.mode);return this.model.collection.on("reset",function(collection){var id;return id=_this.model.get("id"),collection.get(id)?_this.model=collection.get(id):void 0}),this.createShowView(),this.responses=new Comments,this.loadedResponses=!1,this.isQuestion()?this.markedAnswers=new Comments:void 0},DiscussionThreadView.prototype.rerender=function(){return null!=this.showView&&this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),this.initialize({mode:this.mode,model:this.model,el:this.el,course_settings:this.course_settings,topicId:this.topicId}),this.render()},DiscussionThreadView.prototype.renderTemplate=function(){return this.template=_.template($("#thread-template").html()),this.template(this.model.toJSON())},DiscussionThreadView.prototype.render=function(){var _this=this;return this.$el.html(this.renderTemplate()),this.delegateEvents(),this.renderShowView(),this.renderAttrs(),this.$("span.timeago").timeago(),this.makeWmdEditor("reply-body"),this.renderAddResponseButton(),this.responses.on("add",function(response){return _this.renderResponseToList(response,".js-response-list",{})}),this.isQuestion()&&this.markedAnswers.on("add",function(response){return _this.renderResponseToList(response,".js-marked-answer-list",{collapseComments:!0})}),"tab"===this.mode?(setTimeout(function(){return _this.loadInitialResponses()},100),this.$(".post-tools").hide()):this.collapse()},DiscussionThreadView.prototype.attrRenderer=$.extend({},DiscussionContentView.prototype.attrRenderer,{closed:function(closed){return this.$(".discussion-reply-new").toggle(!closed),this.$(".comment-form").closest("li").toggle(!closed),this.renderAddResponseButton()}}),DiscussionThreadView.prototype.expand=function(event){return event&&event.preventDefault(),this.$el.addClass("expanded"),this.$el.find(".post-body").text(this.model.get("body")),this.showView.convertMath(),this.$el.find(".forum-thread-expand").hide(),this.$el.find(".forum-thread-collapse").show(),this.$el.find(".post-extended-content").show(),this.loadedResponses?void 0:this.loadInitialResponses()},DiscussionThreadView.prototype.collapse=function(event){return event&&event.preventDefault(),this.$el.removeClass("expanded"),this.$el.find(".post-body").text(this.getAbbreviatedBody()),this.showView.convertMath(),this.$el.find(".forum-thread-expand").show(),this.$el.find(".forum-thread-collapse").hide(),this.$el.find(".post-extended-content").hide()},DiscussionThreadView.prototype.getAbbreviatedBody=function(){var abbreviated,cached;return cached=this.model.get("abbreviatedBody"),cached?cached:(abbreviated=DiscussionUtil.abbreviateString(this.model.get("body"),140),this.model.set("abbreviatedBody",abbreviated),abbreviated)},DiscussionThreadView.prototype.cleanup=function(){return null!=this.responsesRequest?this.responsesRequest.abort():void 0},DiscussionThreadView.prototype.loadResponses=function(responseLimit,elem,firstLoad){var _this=this;return this.responsesRequest=DiscussionUtil.safeAjax({url:DiscussionUtil.urlFor("retrieve_single_thread",this.model.get("commentable_id"),this.model.id),data:{resp_skip:this.responses.size(),resp_limit:responseLimit?responseLimit:void 0},$elem:elem,$loading:elem,takeFocus:!0,complete:function(){return _this.responseRequest=null},success:function(data){return Content.loadContentInfos(data.annotated_content_info),_this.isQuestion()&&_this.markedAnswers.add(data.content.endorsed_responses),_this.responses.add(_this.isQuestion()?data.content.non_endorsed_responses:data.content.children),_this.renderResponseCountAndPagination(_this.isQuestion()?data.content.non_endorsed_resp_total:data.content.resp_total),_this.trigger("thread:responses:rendered"),_this.loadedResponses=!0},error:function(xhr,textStatus){return"abort"!==textStatus?404===xhr.status?DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("The thread you selected has been deleted. Please select another thread.")):firstLoad?DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading responses. Please reload the page.")):DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading more responses. Please try again.")):void 0}})},DiscussionThreadView.prototype.loadInitialResponses=function(){return this.loadResponses(INITIAL_RESPONSE_PAGE_SIZE,this.$el.find(".js-response-list"),!0)},DiscussionThreadView.prototype.renderResponseCountAndPagination=function(responseTotal){var buttonText,loadMoreButton,responseCountFormat,responseLimit,responsePagination,responsesRemaining,showingResponsesText,_this=this;return responseCountFormat=this.isQuestion()&&0!==this.markedAnswers.length?ngettext("%(numResponses)s other response","%(numResponses)s other responses",responseTotal):ngettext("%(numResponses)s response","%(numResponses)s responses",responseTotal),this.$el.find(".response-count").html(interpolate(responseCountFormat,{numResponses:responseTotal},!0)),responsePagination=this.$el.find(".response-pagination"),responsePagination.empty(),responseTotal>0&&(responsesRemaining=responseTotal-this.responses.size(),showingResponsesText=0===responsesRemaining?gettext("Showing all responses"):interpolate(ngettext("Showing first response","Showing first %(numResponses)s responses",this.responses.size()),{numResponses:this.responses.size()},!0),responsePagination.append($("<span>").addClass("response-display-count").html(_.escape(showingResponsesText))),responsesRemaining>0)?(SUBSEQUENT_RESPONSE_PAGE_SIZE>responsesRemaining?(responseLimit=null,buttonText=gettext("Load all responses")):(responseLimit=SUBSEQUENT_RESPONSE_PAGE_SIZE,buttonText=interpolate(gettext("Load next %(numResponses)s responses"),{numResponses:responseLimit},!0)),loadMoreButton=$("<button>").addClass("load-response-button").html(_.escape(buttonText)),loadMoreButton.click(function(){return _this.loadResponses(responseLimit,loadMoreButton)}),responsePagination.append(loadMoreButton)):void 0},DiscussionThreadView.prototype.renderResponseToList=function(response,listSelector,options){var view;return response.set("thread",this.model),view=new ThreadResponseView($.extend({model:response},options)),view.on("comment:add",this.addComment),view.on("comment:endorse",this.endorseThread),view.render(),this.$el.find(listSelector).append(view.el),view.afterInsert()},DiscussionThreadView.prototype.renderAddResponseButton=function(){return this.model.hasResponses()&&this.model.can("can_reply")&&!this.model.get("closed")?this.$el.find("div.add-response").show():this.$el.find("div.add-response").hide()},DiscussionThreadView.prototype.scrollToAddResponse=function(event){var form;return event.preventDefault(),form=$(event.target).parents("article.discussion-article").find("form.discussion-reply-new"),$("html, body").scrollTop(form.offset().top),form.find(".wmd-panel textarea").focus()},DiscussionThreadView.prototype.addComment=function(){return this.model.comment()},DiscussionThreadView.prototype.endorseThread=function(){return this.model.set("endorsed",this.$el.find(".action-answer.is-checked").length>0)},DiscussionThreadView.prototype.submitComment=function(event){var body,comment,url;return event.preventDefault(),url=this.model.urlFor("reply"),body=this.getWmdContent("reply-body"),body.trim().length?(this.setWmdContent("reply-body",""),comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),votes:{up_count:0},abuse_flaggers:[],endorsed:!1,user_id:window.user.get("id")}),comment.set("thread",this.model.get("thread")),this.renderResponseToList(comment,".js-response-list"),this.model.addComment(),this.renderAddResponseButton(),DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(data){return comment.updateInfo(data.annotated_content_info),comment.set(data.content)}})):void 0},DiscussionThreadView.prototype.edit=function(){return this.createEditView(),this.renderEditView()},DiscussionThreadView.prototype.createEditView=function(){return null!=this.showView&&(this.showView.undelegateEvents(),this.showView.$el.empty(),this.showView=null),this.editView=new DiscussionThreadEditView({container:this.$(".thread-content-wrapper"),model:this.model,mode:this.mode,course_settings:this.options.course_settings}),this.editView.bind("thread:updated thread:cancel_edit",this.closeEditView),this.editView.bind("comment:endorse",this.endorseThread)},DiscussionThreadView.prototype.renderSubView=function(view){return view.setElement(this.$(".thread-content-wrapper")),view.render(),view.delegateEvents()},DiscussionThreadView.prototype.renderEditView=function(){return this.editView.render()},DiscussionThreadView.prototype.createShowView=function(){return this.showView=new DiscussionThreadShowView({model:this.model,mode:this.mode}),this.showView.bind("thread:_delete",this._delete),this.showView.bind("thread:edit",this.edit)},DiscussionThreadView.prototype.renderShowView=function(){return this.renderSubView(this.showView)},DiscussionThreadView.prototype.closeEditView=function(){return this.createShowView(),this.renderShowView(),this.$el.find(".post-extended-content").show()},DiscussionThreadView.prototype._delete=function(event){var $elem,url;return url=this.model.urlFor("_delete"),this.model.can("can_delete")&&confirm(gettext("Are you sure you want to delete this post?"))?(this.model.remove(),this.showView.undelegateEvents(),this.undelegateEvents(),this.$el.empty(),$elem=$(event.target),DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(){}})):void 0},DiscussionThreadView}(DiscussionContentView))}.call(this),function(Backbone){"use strict";Backbone&&(this.DiscussionTopicMenuView=Backbone.View.extend({events:{"click .post-topic-button":"toggleTopicDropdown","click .topic-menu-wrapper":"handleTopicEvent","click .topic-filter-label":"ignoreClick","keyup .topic-filter-input":this.DiscussionFilter.filterDrop},attributes:{"class":"post-field"},initialize:function(options){return this.course_settings=options.course_settings,this.currentTopicId=options.topicId,this.maxNameWidth=100,_.bindAll(this),this},ignoreClick:function(event){return event.stopPropagation(),this},render:function(){var context=_.clone(this.course_settings.attributes);return context.topics_html=this.renderCategoryMap(this.course_settings.get("category_map")),this.$el.html(_.template($("#topic-template").html(),context)),this.dropdownButton=this.$(".post-topic-button"),this.topicMenu=this.$(".topic-menu-wrapper"),this.selectedTopic=this.$(".js-selected-topic"),this.hideTopicDropdown(),this.setTopic(this.getCurrentTopicId()?this.$("a.topic-title").filter('[data-discussion-id="'+this.getCurrentTopicId()+'"]'):this.$("a.topic-title").first()),this.$el},renderCategoryMap:function(map){var category_template=_.template($("#new-post-menu-category-template").html()),entry_template=_.template($("#new-post-menu-entry-template").html());return _.map(map.children,function(name){var entry,html="";return _.has(map.entries,name)?(entry=map.entries[name],html=entry_template({text:name,id:entry.id,is_cohorted:entry.is_cohorted})):html=category_template({text:name,entries:this.renderCategoryMap(map.subcategories[name])}),html},this).join("")},toggleTopicDropdown:function(event){return event.preventDefault(),event.stopPropagation(),this.menuOpen?this.hideTopicDropdown():this.showTopicDropdown(),this},showTopicDropdown:function(){return this.menuOpen=!0,this.dropdownButton.addClass("dropped"),this.topicMenu.show(),$(document.body).on("click.topicMenu",this.hideTopicDropdown),this.maxNameWidth=this.dropdownButton.width()-40,this},hideTopicDropdown:function(){return this.menuOpen=!1,this.dropdownButton.removeClass("dropped"),this.topicMenu.hide(),$(document.body).off("click.topicMenu"),this},handleTopicEvent:function(event){return event.preventDefault(),event.stopPropagation(),this.setTopic($(event.target)),this},setTopic:function($target){return $target.data("discussion-id")&&(this.topicText=this.getFullTopicName($target),this.currentTopicId=$target.data("discussion-id"),this.setSelectedTopicName(this.topicText),this.trigger("thread:topic_change",$target),this.hideTopicDropdown()),this
},getCurrentTopicId:function(){return this.currentTopicId},setSelectedTopicName:function(text){return this.selectedTopic.html(this.fitName(text))},getFullTopicName:function(topicElement){var name;return topicElement?(name=topicElement.html(),_.each(topicElement.parents(".topic-submenu"),function(item){name=$(item).siblings(".topic-title").text()+" / "+name}),name):this.topicText},getNameWidth:function(name){var width,test=$("<div>");return test.css({"font-size":this.dropdownButton.css("font-size"),opacity:0,position:"absolute",left:-1e3,top:-1e3}).html(name).appendTo(document.body),width=test.width(),test.remove(),width},fitName:function(name){var partialName,path,rawName,ellipsisText=gettext("…");if(this.getNameWidth(name)<this.maxNameWidth)return name;for(path=_.map(name.split("/"),function(item){return item.replace(/^\s+|\s+$/g,"")});path.length>1;)if(path.shift(),partialName=ellipsisText+" / "+path.join(" / "),this.getNameWidth(partialName)<this.maxNameWidth)return partialName;for(rawName=path[0],name=ellipsisText+" / "+rawName;this.getNameWidth(name)>this.maxNameWidth;)rawName=rawName.slice(0,-1),name=ellipsisText+" / "+rawName+" "+ellipsisText;return name}}))}.call(this,Backbone),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.DiscussionUserProfileView=function(_super){function DiscussionUserProfileView(){var _this=this;return this.render=function(){return DiscussionUserProfileView.prototype.render.apply(_this,arguments)},DiscussionUserProfileView.__super__.constructor.apply(this,arguments)}return __extends(DiscussionUserProfileView,_super),DiscussionUserProfileView.prototype.events={"click .discussion-paginator a":"changePage"},DiscussionUserProfileView.prototype.initialize=function(options){return DiscussionUserProfileView.__super__.initialize.call(this),this.page=options.page,this.numPages=options.numPages,this.discussion=new Discussion,this.discussion.on("reset",this.render),this.discussion.reset(this.collection,{silent:!1})},DiscussionUserProfileView.prototype.render=function(){var baseUri,pageUrlFunc,paginationParams,paginationTemplate,profileTemplate;return profileTemplate=$("script#_user_profile").html(),this.$el.html(Mustache.render(profileTemplate,{threads:this.discussion.models})),this.discussion.map(function(thread){return new DiscussionThreadProfileView({el:this.$("article#thread_"+thread.id),model:thread}).render()}),baseUri=URI(window.location).removeSearch("page"),pageUrlFunc=function(page){return baseUri.clone().addSearch("page",page)},paginationParams=DiscussionUtil.getPaginationParams(this.page,this.numPages,pageUrlFunc),paginationTemplate=$("script#_pagination").html(),this.$el.find(".pagination").html(Mustache.render(paginationTemplate,paginationParams))},DiscussionUserProfileView.prototype.changePage=function(event){var url,_this=this;return event.preventDefault(),url=$(event.target).attr("href"),DiscussionUtil.safeAjax({$elem:this.$el,$loading:$(event.target),takeFocus:!0,url:url,type:"GET",dataType:"json",success:function(response){return _this.page=response.page,_this.numPages=response.num_pages,_this.discussion.reset(response.discussion_data,{silent:!1}),history.pushState({},"",url)},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble loading the page you requested. Please try again."))}})},DiscussionUserProfileView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.NewPostView=function(_super){function NewPostView(){var _this=this;return this.updateStyles=function(){return NewPostView.prototype.updateStyles.apply(_this,arguments)},this.resetForm=function(){return NewPostView.prototype.resetForm.apply(_this,arguments)},NewPostView.__super__.constructor.apply(this,arguments)}return __extends(NewPostView,_super),NewPostView.prototype.initialize=function(options){var _ref;if(this.mode=options.mode||"inline","tab"!==(_ref=this.mode)&&"inline"!==_ref)throw new Error("invalid mode: "+this.mode);return this.course_settings=options.course_settings,this.topicId=options.topicId},NewPostView.prototype.render=function(){var context,threadTypeTemplate;return context=_.clone(this.course_settings.attributes),_.extend(context,{cohort_options:this.getCohortOptions(),mode:this.mode,form_id:this.mode+(this.topicId?"-"+this.topicId:"")}),this.$el.html(_.template($("#new-post-template").html(),context)),threadTypeTemplate=_.template($("#thread-type-template").html()),this.addField(threadTypeTemplate({form_id:_.uniqueId("form-")})),this.isTabMode()&&(this.topicView=new DiscussionTopicMenuView({topicId:this.topicId,course_settings:this.course_settings}),this.topicView.on("thread:topic_change",this.toggleGroupDropdown),this.addField(this.topicView.render())),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"js-post-body")},NewPostView.prototype.addField=function(fieldView){return this.$(".forum-new-post-form-wrapper").append(fieldView)},NewPostView.prototype.isTabMode=function(){return"tab"===this.mode},NewPostView.prototype.getCohortOptions=function(){var user_cohort_id;return this.course_settings.get("is_cohorted")&&DiscussionUtil.isPrivilegedUser()?(user_cohort_id=$("#discussion-container").data("user-cohort-id"),_.map(this.course_settings.get("cohorts"),function(cohort){return{value:cohort.id,text:cohort.name,selected:cohort.id===user_cohort_id}})):null},NewPostView.prototype.events={"submit .forum-new-post-form":"createPost","change .post-option-input":"postOptionChange","click .cancel":"cancel","reset .forum-new-post-form":"updateStyles"},NewPostView.prototype.toggleGroupDropdown=function($target){return $target.data("cohorted")?$(".js-group-select").prop("disabled",!1):$(".js-group-select").val("").prop("disabled",!0)},NewPostView.prototype.postOptionChange=function(event){var $optionElem,$target;return $target=$(event.target),$optionElem=$target.closest(".post-option"),$target.is(":checked")?$optionElem.addClass("is-enabled"):$optionElem.removeClass("is-enabled")},NewPostView.prototype.createPost=function(event){var anonymous,anonymous_to_peers,body,follow,group,thread_type,title,topicId,url,_this=this;return event.preventDefault(),thread_type=this.$(".post-type-input:checked").val(),title=this.$(".js-post-title").val(),body=this.$(".js-post-body").find(".wmd-input").val(),group=this.$(".js-group-select option:selected").attr("value"),anonymous=!1||this.$(".js-anon").is(":checked"),anonymous_to_peers=!1||this.$(".js-anon-peers").is(":checked"),follow=!1||this.$(".js-follow").is(":checked"),topicId=this.isTabMode()?this.topicView.getCurrentTopicId():this.topicId,url=DiscussionUtil.urlFor("create_thread",topicId),DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:!1,data:{thread_type:thread_type,title:title,body:body,anonymous:anonymous,anonymous_to_peers:anonymous_to_peers,auto_subscribe:follow,group_id:group},error:DiscussionUtil.formErrorHandler(this.$(".post-errors")),success:function(response){var thread;return thread=new Thread(response.content),_this.$el.hide(),_this.resetForm(),_this.collection.add(thread)}})},NewPostView.prototype.cancel=function(event){return event.preventDefault(),confirm(gettext("Your post will be discarded."))?(this.trigger("newPost:cancel"),this.resetForm()):void 0},NewPostView.prototype.resetForm=function(){return this.$(".forum-new-post-form")[0].reset(),DiscussionUtil.clearFormErrors(this.$(".post-errors")),this.$(".wmd-preview p").html(""),this.isTabMode()?this.topicView.setTopic(this.$("a.topic-title").first()):void 0},NewPostView.prototype.updateStyles=function(){var _this=this;return setTimeout(function(){return _this.$(".post-option-input").trigger("change")},1)},NewPostView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ResponseCommentEditView=function(_super){function ResponseCommentEditView(){return ResponseCommentEditView.__super__.constructor.apply(this,arguments)}return __extends(ResponseCommentEditView,_super),ResponseCommentEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"},ResponseCommentEditView.prototype.$=function(selector){return this.$el.find(selector)},ResponseCommentEditView.prototype.initialize=function(){return ResponseCommentEditView.__super__.initialize.call(this)},ResponseCommentEditView.prototype.render=function(){return this.template=_.template($("#response-comment-edit-template").html()),this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-comment-body"),this},ResponseCommentEditView.prototype.update=function(event){return this.trigger("comment:update",event)},ResponseCommentEditView.prototype.cancel_edit=function(event){return this.trigger("comment:cancel_edit",event)},ResponseCommentEditView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ResponseCommentShowView=function(_super){function ResponseCommentShowView(){var _this=this;return this.edit=function(){return ResponseCommentShowView.prototype.edit.apply(_this,arguments)},this._delete=function(){return ResponseCommentShowView.prototype._delete.apply(_this,arguments)},ResponseCommentShowView.__super__.constructor.apply(this,arguments)}return __extends(ResponseCommentShowView,_super),ResponseCommentShowView.prototype.tagName="li",ResponseCommentShowView.prototype.render=function(){return this.template=_.template($("#response-comment-show-template").html()),this.$el.html(this.template(_.extend({cid:this.model.cid,author_display:this.getAuthorDisplay()},this.model.attributes))),this.delegateEvents(),this.renderAttrs(),this.$el.find(".timeago").timeago(),this.convertMath(),this.addReplyLink(),this},ResponseCommentShowView.prototype.addReplyLink=function(){var html,name,p,_ref;return this.model.hasOwnProperty("parent")?(name=null!=(_ref=this.model.parent.get("username"))?_ref:gettext("anonymous"),html="<a href='#comment_"+this.model.parent.id+"'>@"+name+"</a>:  ",p=this.$(".response-body p:first"),p.prepend(html)):void 0},ResponseCommentShowView.prototype.convertMath=function(){var body;return body=this.$el.find(".response-body"),body.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(body.text()))),MathJax.Hub.Queue(["Typeset",MathJax.Hub,body[0]])},ResponseCommentShowView.prototype._delete=function(event){return this.trigger("comment:_delete",event)},ResponseCommentShowView.prototype.edit=function(event){return this.trigger("comment:edit",event)},ResponseCommentShowView}(DiscussionContentShowView))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ResponseCommentView=function(_super){function ResponseCommentView(){var _this=this;return this.update=function(){return ResponseCommentView.prototype.update.apply(_this,arguments)},this.edit=function(){return ResponseCommentView.prototype.edit.apply(_this,arguments)},this.cancelEdit=function(){return ResponseCommentView.prototype.cancelEdit.apply(_this,arguments)},this._delete=function(){return ResponseCommentView.prototype._delete.apply(_this,arguments)},ResponseCommentView.__super__.constructor.apply(this,arguments)}return __extends(ResponseCommentView,_super),ResponseCommentView.prototype.tagName="li",ResponseCommentView.prototype.$=function(selector){return this.$el.find(selector)},ResponseCommentView.prototype.initialize=function(){return ResponseCommentView.__super__.initialize.call(this)},ResponseCommentView.prototype.render=function(){return this.renderShowView(),this},ResponseCommentView.prototype.renderSubView=function(view){return view.setElement(this.$el),view.render(),view.delegateEvents()},ResponseCommentView.prototype.renderShowView=function(){return null==this.showView?(null!=this.editView&&(this.editView.undelegateEvents(),this.editView.$el.empty(),this.editView=null),this.showView=new ResponseCommentShowView({model:this.model}),this.showView.bind("comment:_delete",this._delete),this.showView.bind("comment:edit",this.edit),this.renderSubView(this.showView)):void 0},ResponseCommentView.prototype.renderEditView=function(){return null==this.editView?(null!=this.showView&&(this.showView.undelegateEvents(),this.showView.$el.empty(),this.showView=null),this.editView=new ResponseCommentEditView({model:this.model}),this.editView.bind("comment:update",this.update),this.editView.bind("comment:cancel_edit",this.cancelEdit),this.renderSubView(this.editView)):void 0},ResponseCommentView.prototype._delete=function(event){var $elem,url,_this=this;return event.preventDefault(),this.model.can("can_delete")&&confirm(gettext("Are you sure you want to delete this comment?"))?(url=this.model.urlFor("_delete"),$elem=$(event.target),DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(){return _this.model.remove(),_this.$el.remove()},error:function(){return DiscussionUtil.discussionAlert(gettext("Sorry"),gettext("We had some trouble deleting this comment. Please try again."))}})):void 0},ResponseCommentView.prototype.cancelEdit=function(event){return this.trigger("comment:cancel_edit",event),this.renderShowView()},ResponseCommentView.prototype.edit=function(event){return this.trigger("comment:edit",event),this.renderEditView()},ResponseCommentView.prototype.update=function(event){var newBody,url,_this=this;return newBody=this.editView.$(".edit-comment-body textarea").val(),url=DiscussionUtil.urlFor("update_comment",this.model.id),DiscussionUtil.safeAjax({$elem:$(event.target),$loading:$(event.target),url:url,type:"POST",dataType:"json",data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-comment-form-errors")),success:function(){return _this.model.set("body",newBody),_this.cancelEdit()}})},ResponseCommentView}(DiscussionContentView))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ThreadResponseEditView=function(_super){function ThreadResponseEditView(){return ThreadResponseEditView.__super__.constructor.apply(this,arguments)}return __extends(ThreadResponseEditView,_super),ThreadResponseEditView.prototype.events={"click .post-update":"update","click .post-cancel":"cancel_edit"},ThreadResponseEditView.prototype.$=function(selector){return this.$el.find(selector)},ThreadResponseEditView.prototype.initialize=function(){return ThreadResponseEditView.__super__.initialize.call(this)},ThreadResponseEditView.prototype.render=function(){return this.template=_.template($("#thread-response-edit-template").html()),this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),DiscussionUtil.makeWmdEditor(this.$el,$.proxy(this.$,this),"edit-post-body"),this},ThreadResponseEditView.prototype.update=function(event){return this.trigger("response:update",event)},ThreadResponseEditView.prototype.cancel_edit=function(event){return this.trigger("response:cancel_edit",event)},ThreadResponseEditView}(Backbone.View))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ThreadResponseShowView=function(_super){function ThreadResponseShowView(){return ThreadResponseShowView.__super__.constructor.apply(this,arguments)}return __extends(ThreadResponseShowView,_super),ThreadResponseShowView.prototype.initialize=function(){return ThreadResponseShowView.__super__.initialize.call(this),this.listenTo(this.model,"change",this.render)},ThreadResponseShowView.prototype.renderTemplate=function(){var context;return this.template=_.template($("#thread-response-show-template").html()),context=_.extend({cid:this.model.cid,author_display:this.getAuthorDisplay(),endorser_display:this.getEndorserDisplay()},this.model.attributes),this.template(context)},ThreadResponseShowView.prototype.render=function(){return this.$el.html(this.renderTemplate()),this.delegateEvents(),this.renderAttrs(),this.$el.find(".posted-details .timeago").timeago(),this.convertMath(),this},ThreadResponseShowView.prototype.convertMath=function(){var element;return element=this.$(".response-body"),element.html(DiscussionUtil.postMathJaxProcessor(DiscussionUtil.markdownWithHighlight(element.text()))),MathJax.Hub.Queue(["Typeset",MathJax.Hub,element[0]])},ThreadResponseShowView.prototype.edit=function(event){return this.trigger("response:edit",event)},ThreadResponseShowView.prototype._delete=function(event){return this.trigger("response:_delete",event)},ThreadResponseShowView}(DiscussionContentShowView))}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};"undefined"!=typeof Backbone&&null!==Backbone&&(this.ThreadResponseView=function(_super){function ThreadResponseView(){var _this=this;return this.update=function(){return ThreadResponseView.prototype.update.apply(_this,arguments)},this.edit=function(){return ThreadResponseView.prototype.edit.apply(_this,arguments)},this.cancelEdit=function(){return ThreadResponseView.prototype.cancelEdit.apply(_this,arguments)},this._delete=function(){return ThreadResponseView.prototype._delete.apply(_this,arguments)},this.renderComment=function(){return ThreadResponseView.prototype.renderComment.apply(_this,arguments)},ThreadResponseView.__super__.constructor.apply(this,arguments)}return __extends(ThreadResponseView,_super),ThreadResponseView.prototype.tagName="li",ThreadResponseView.prototype.className="forum-response",ThreadResponseView.prototype.events={"click .discussion-submit-comment":"submitComment","focus .wmd-input":"showEditorChrome"},ThreadResponseView.prototype.$=function(selector){return this.$el.find(selector)},ThreadResponseView.prototype.initialize=function(options){return this.collapseComments=options.collapseComments,this.createShowView()},ThreadResponseView.prototype.renderTemplate=function(){var templateData,_ref;return this.template=_.template($("#thread-response-template").html()),templateData=this.model.toJSON(),templateData.wmdId=null!=(_ref=this.model.id)?_ref:(new Date).getTime(),this.template(templateData)},ThreadResponseView.prototype.render=function(){return this.$el.addClass("response_"+this.model.get("id")),this.$el.html(this.renderTemplate()),this.delegateEvents(),this.renderShowView(),this.renderAttrs(),this.model.get("thread").get("closed")&&this.hideCommentForm(),this.renderComments(),this},ThreadResponseView.prototype.afterInsert=function(){return this.makeWmdEditor("comment-body"),this.hideEditorChrome()},ThreadResponseView.prototype.hideEditorChrome=function(){return this.$(".wmd-button-row").hide(),this.$(".wmd-preview-container").hide(),this.$(".wmd-input").css({height:"35px",padding:"5px"}),this.$(".comment-post-control").hide()},ThreadResponseView.prototype.showEditorChrome=function(){return this.$(".wmd-button-row").show(),this.$(".wmd-preview-container").show(),this.$(".comment-post-control").show(),this.$(".wmd-input").css({height:"125px",padding:"10px"})},ThreadResponseView.prototype.renderComments=function(){var collectComments,comments,_this=this;return comments=new Comments,this.commentViews=[],comments.comparator=function(comment){return comment.get("created_at")},collectComments=function(comment){var children;return comments.add(comment),children=new Comments(comment.get("children")),children.each(function(child){return child.parent=comment,collectComments(child)})},this.model.get("comments").each(collectComments),comments.each(function(comment){return _this.renderComment(comment,!1,null)}),this.collapseComments&&comments.length?(this.$(".comments").hide(),this.$(".action-show-comments").on("click",function(event){return event.preventDefault(),_this.$(".action-show-comments").hide(),_this.$(".comments").show()})):this.$(".action-show-comments").hide()},ThreadResponseView.prototype.renderComment=function(comment){var view,_this=this;return comment.set("thread",this.model.get("thread")),view=new ResponseCommentView({model:comment}),view.render(),this.$el.find(".comments .new-comment").before(view.el),view.bind("comment:edit",function(event){return null!=_this.editView&&_this.cancelEdit(event),_this.cancelCommentEdits(),_this.hideCommentForm()}),view.bind("comment:cancel_edit",function(){return _this.showCommentForm()}),this.commentViews.push(view),view},ThreadResponseView.prototype.submitComment=function(event){var body,comment,url,view;return event.preventDefault(),url=this.model.urlFor("reply"),body=this.getWmdContent("comment-body"),body.trim().length?(this.setWmdContent("comment-body",""),comment=new Comment({body:body,created_at:(new Date).toISOString(),username:window.user.get("username"),abuse_flaggers:[],user_id:window.user.get("id"),id:"unsaved"}),view=this.renderComment(comment),this.hideEditorChrome(),this.trigger("comment:add",comment),DiscussionUtil.safeAjax({$elem:$(event.target),url:url,type:"POST",dataType:"json",data:{body:body},success:function(response){return comment.set(response.content),comment.updateInfo(response.annotated_content_info),view.render()}})):void 0},ThreadResponseView.prototype._delete=function(event){var $elem,url;return event.preventDefault(),this.model.can("can_delete")&&confirm(gettext("Are you sure you want to delete this response?"))?(url=this.model.urlFor("_delete"),this.model.remove(),this.$el.remove(),$elem=$(event.target),DiscussionUtil.safeAjax({$elem:$elem,url:url,type:"POST",success:function(){}})):void 0},ThreadResponseView.prototype.createEditView=function(){return null!=this.showView&&(this.showView.undelegateEvents(),this.showView.$el.empty(),this.showView=null),this.editView=new ThreadResponseEditView({model:this.model}),this.editView.bind("response:update",this.update),this.editView.bind("response:cancel_edit",this.cancelEdit)},ThreadResponseView.prototype.renderSubView=function(view){return view.setElement(this.$(".discussion-response")),view.render(),view.delegateEvents()},ThreadResponseView.prototype.renderEditView=function(){return this.renderSubView(this.editView)},ThreadResponseView.prototype.cancelCommentEdits=function(){return _.each(this.commentViews,function(view){return view.cancelEdit()})},ThreadResponseView.prototype.hideCommentForm=function(){return this.$(".comment-form").closest("li").hide()},ThreadResponseView.prototype.showCommentForm=function(){return this.$(".comment-form").closest("li").show()},ThreadResponseView.prototype.createShowView=function(){var _this=this;return null!=this.editView&&(this.editView.undelegateEvents(),this.editView.$el.empty(),this.editView=null),this.showView=new ThreadResponseShowView({model:this.model}),this.showView.bind("response:_delete",this._delete),this.showView.bind("response:edit",this.edit),this.showView.on("comment:endorse",function(){return _this.trigger("comment:endorse")})},ThreadResponseView.prototype.renderShowView=function(){return this.renderSubView(this.showView)},ThreadResponseView.prototype.cancelEdit=function(event){return event.preventDefault(),this.createShowView(),this.renderShowView(),this.showCommentForm()},ThreadResponseView.prototype.edit=function(){return this.createEditView(),this.renderEditView(),this.cancelCommentEdits(),this.hideCommentForm()},ThreadResponseView.prototype.update=function(event){var newBody,url,_this=this;return newBody=this.editView.$(".edit-post-body textarea").val(),url=DiscussionUtil.urlFor("update_comment",this.model.id),DiscussionUtil.safeAjax({$elem:$(event.target),$loading:event?$(event.target):void 0,url:url,type:"POST",dataType:"json",async:!1,data:{body:newBody},error:DiscussionUtil.formErrorHandler(this.$(".edit-post-form-errors")),success:function(){return _this.editView.$(".edit-post-body textarea").val("").attr("prev-text",""),_this.editView.$(".wmd-preview p").html(""),_this.model.set({body:newBody}),_this.createShowView(),_this.renderShowView(),_this.showCommentForm()}})},ThreadResponseView}(DiscussionContentView))}.call(this);